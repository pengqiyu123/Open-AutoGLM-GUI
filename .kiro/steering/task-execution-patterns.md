---
inclusion: always
---

# 任务执行模式与纠错指南 - GUI 电脑版

本文档记录 Open-AutoGLM GUI 电脑版常见任务的正确执行步骤和历史错误。

## 核心原则

1. **先检查后执行** - 在执行任何操作前，先验证前置条件
2. **增量验证** - 每个步骤完成后立即验证结果
3. **失败快速恢复** - 遇到错误时，参考本文档的解决方案
4. **记录新模式** - 新的成功/失败案例应添加到本文档

## 常见任务执行模式

### 1. 构建 GUI 可执行文件

**正确步骤：**
```
1. 检查 Python 环境和依赖
   - 验证 Python 版本（推荐 3.8+）
   - 检查 requirements.txt 中的依赖是否已安装
   
2. 测试源代码运行
   - 执行 python gui_app.py
   - 确认 GUI 能正常启动和运行
   
3. 检查构建配置
   - 查看 build_gui.spec 文件
   - 确认 hiddenimports 和资源文件配置
   
4. 执行构建
   - 运行 build_gui_with_progress.bat
   - 观察构建过程输出
   
5. 验证构建结果
   - 检查 dist 目录下是否生成 GUI.exe
   - 测试 GUI.exe 能否正常运行
```

**常见错误：**
- ❌ 不检查依赖就直接构建
- ❌ 不测试源代码就打包
- ❌ 忽略构建过程中的警告
- ❌ 不验证生成的 exe 文件

**纠正方案：**
- ✅ 先运行 `pip install -r requirements.txt`
- ✅ 先测试 `python gui_app.py` 能否运行
- ✅ 仔细查看构建日志，处理警告
- ✅ 构建后立即测试 exe 文件

### 2. 修改 Python 代码

**正确步骤：**
```
1. 读取完整文件内容
   - 使用 readFile 读取要修改的文件
   - 确认代码结构和上下文
   
2. 定位修改位置
   - 找到要修改的代码块
   - 确保 oldStr 足够唯一（包含前后2-3行）
   
3. 执行替换
   - 使用 strReplace 进行精确替换
   - 确保缩进和格式正确
   
4. 验证修改
   - 使用 getDiagnostics 检查语法错误
   - 如果是关键文件，运行测试
```

**常见错误：**
- ❌ 不读取文件就尝试替换
- ❌ oldStr 不够唯一，匹配多处
- ❌ 缩进错误（Python 对缩进敏感）
- ❌ 修改后不验证

**纠正方案：**
- ✅ 始终先读取文件确认内容
- ✅ oldStr 包含足够上下文
- ✅ 保持原有缩进风格（4空格或tab）
- ✅ 修改后运行 getDiagnostics

### 3. 配置 ADB 和设备连接

**正确步骤：**
```
1. 检查 ADB 工具
   - 验证 platform-tools 目录存在
   - 检查 adb.exe 文件
   
2. 启动 ADB 服务
   - 执行 adb start-server
   - 确认服务启动成功
   
3. 连接设备
   - 确保设备开启 USB 调试
   - 执行 adb devices 查看设备列表
   
4. 验证连接
   - 确认设备显示为 "device" 状态
   - 测试简单命令如 adb shell echo test
```

**常见错误：**
- ❌ 假设 ADB 已经启动
- ❌ 不检查设备 USB 调试状态
- ❌ 忽略 ADB 版本冲突
- ❌ 不验证连接状态

**纠正方案：**
- ✅ 先执行 adb devices 检查状态
- ✅ 如果失败，重启 ADB：adb kill-server && adb start-server
- ✅ 提供清晰的设备连接指引
- ✅ 添加自动重连机制

### 4. 测试 API 连接

**正确步骤：**
```
1. 检查 API 配置
   - 验证 API key 是否配置
   - 检查 API 端点 URL
   
2. 测试网络连接
   - 使用 test_api.py 测试连接
   - 确认能够访问 API 服务
   
3. 验证 API key
   - 发送简单的测试请求
   - 确认返回正常响应
   
4. 处理错误
   - 添加超时设置
   - 实现重试机制
   - 提供清晰的错误提示
```

**常见错误：**
- ❌ 不验证 API key 就开始使用
- ❌ 没有网络错误处理
- ❌ 超时设置过短或过长
- ❌ 错误提示不清晰

**纠正方案：**
- ✅ 启动时验证 API key
- ✅ 添加网络异常捕获
- ✅ 设置合理的超时时间（如30秒）
- ✅ 显示具体的错误原因

### 5. 更新依赖包

**正确步骤：**
```
1. 备份当前环境
   - 导出当前依赖：pip freeze > requirements_backup.txt
   
2. 更新依赖
   - 修改 requirements.txt
   - 执行 pip install -r requirements.txt
   
3. 测试兼容性
   - 运行 python gui_app.py
   - 测试主要功能
   
4. 更新构建配置
   - 如果需要，更新 build_gui.spec
   - 重新构建测试
```

**常见错误：**
- ❌ 不备份就更新
- ❌ 更新后不测试
- ❌ 忽略版本冲突
- ❌ 不更新构建配置

**纠正方案：**
- ✅ 先备份当前环境
- ✅ 更新后立即测试
- ✅ 检查依赖兼容性
- ✅ 同步更新所有相关配置

### 6. 添加新功能到 GUI

**正确步骤：**
```
1. 规划功能
   - 明确功能需求
   - 设计界面布局
   - 确定代码位置
   
2. 修改代码
   - 在 gui_app.py 或相关模块中添加代码
   - 保持代码风格一致
   - 添加必要的注释
   
3. 测试功能
   - 运行 python gui_app.py
   - 测试新功能是否正常工作
   - 测试与现有功能的兼容性
   
4. 更新文档
   - 更新 README.md
   - 更新使用说明
   
5. 重新构建
   - 执行 build_gui_with_progress.bat
   - 测试 exe 文件中的新功能
```

**常见错误：**
- ❌ 不规划就直接写代码
- ❌ 代码风格不一致
- ❌ 不测试就提交
- ❌ 不更新文档

**纠正方案：**
- ✅ 先设计后实现
- ✅ 遵循现有代码风格
- ✅ 充分测试新功能
- ✅ 同步更新文档

## 错误恢复策略

### 构建失败
1. 检查错误日志中的具体原因
2. 常见原因：依赖缺失、路径错误、资源文件问题
3. 逐个排查并修复
4. 重新构建验证

### 运行时错误
1. 查看日志文件（logs 目录）
2. 定位错误堆栈
3. 检查配置、文件路径、权限
4. 添加防御性代码

### ADB 连接问题
1. 重启 ADB 服务
2. 检查设备 USB 调试
3. 尝试不同的 USB 端口
4. 检查驱动程序

### API 调用失败
1. 验证 API key
2. 检查网络连接
3. 查看 API 服务状态
4. 实现降级方案

## 任务执行检查清单

每次执行重复任务前，参考以下清单：

- [ ] 是否读取了相关文档和历史记录？
- [ ] 是否验证了前置条件？
- [ ] 是否有明确的步骤计划？
- [ ] 每个步骤是否有验证机制？
- [ ] 是否考虑了错误处理？
- [ ] 是否参考了本文档的相关模式？

## 日志记录规范

当发现新的错误模式时，应该记录：

```markdown
### [任务名称]

**错误现象：**
[描述问题]

**错误原因：**
[根本原因分析]

**正确步骤：**
[详细步骤]

**验证方法：**
[如何确认成功]
```

## 持续改进

本文档应该随着项目发展不断更新：
- 记录新的任务模式
- 更新错误解决方案
- 删除过时的信息
- 优化步骤流程
