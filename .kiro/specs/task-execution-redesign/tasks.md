# 任务执行与数据持久化重构 - 实施任务

## 阶段 1: 核心架构组件

### 1. 实现任务状态机 (TaskStateMachine)

- [ ] 1.1 创建 TaskState 枚举类
  - 定义所有任务状态（CREATED, RUNNING, STOPPING, STOPPED, SUCCESS, FAILED, CRASHED）
  - 添加状态描述和显示名称
  - _验收: 需求 1.1-1.7_

- [ ] 1.2 实现 TaskStateMachine 类
  - 实现状态转换逻辑
  - 实现状态转换验证
  - 添加线程锁保护
  - _验收: 需求 1.1-1.7_

- [ ] 1.3 集成状态持久化
  - 状态转换时立即写入数据库
  - 添加状态转换事件通知
  - _验收: 需求 1.7_

- [ ]* 1.4 编写状态机单元测试
  - 测试所有合法状态转换
  - 测试非法状态转换被拒绝
  - 测试并发状态转换
  - _验收: 需求 10.3_

### 2. 实现数据持久化层

- [ ] 2.1 创建 TaskRepository 类
  - 实现 create_task() 方法
  - 实现 update_task_state() 方法
  - 实现 finalize_task() 方法
  - 添加重试机制
  - _验收: 需求 2.1-2.7, 5.1-5.7_

- [ ] 2.2 创建 StepRepository 类
  - 实现 insert_step() 方法
  - 实现 batch_insert_steps() 方法
  - 实现 step_exists() 方法
  - 添加事务支持
  - _验收: 需求 2.1-2.7, 5.1-5.7_

- [ ] 2.3 实现连接池 (ConnectionPool)
  - 创建连接池管理器
  - 实现连接获取和释放
  - 配置 WAL 模式
  - _验收: 需求 9.1-9.6_

- [ ] 2.4 实现 BackupManager 类
  - 实现 save_task_backup() 方法
  - 实现 save_step_backup() 方法
  - 实现 recover_from_backup() 方法
  - 实现 cleanup_backup() 方法
  - _验收: 需求 2.5, 7.1-7.7_

- [ ]* 2.5 编写持久化层单元测试
  - 测试任务 CRUD 操作
  - 测试步骤 CRUD 操作
  - 测试事务回滚
  - 测试备份和恢复
  - _验收: 需求 10.1-10.7_

### 3. 数据模型定义

- [ ] 3.1 创建数据类
  - 定义 TaskData dataclass
  - 定义 StepData dataclass
  - 添加序列化/反序列化方法
  - _验收: 设计文档_

- [ ] 3.2 数据库 schema 更新
  - 添加 updated_at 字段到 tasks 表
  - 创建必要的索引
  - 编写迁移脚本
  - _验收: 需求 5.1-5.7_

## 阶段 2: 任务执行器

### 4. 实现步骤缓冲区 (StepBuffer)

- [ ] 4.1 创建 StepBuffer 类
  - 实现 add_step() 方法（同步写入）
  - 实现 flush() 方法
  - 实现缓冲区验证逻辑
  - _验收: 需求 3.1-3.7_

- [ ] 4.2 集成备份机制
  - 写入失败时保存到备份
  - 实现备份文件格式（JSONL）
  - _验收: 需求 3.7, 7.3_

- [ ]* 4.3 编写缓冲区单元测试
  - 测试步骤添加和刷新
  - 测试备份保存
  - 测试并发访问
  - _验收: 需求 10.1-10.7_

### 5. 实现任务执行器 (TaskExecutor)

- [ ] 5.1 创建 TaskExecutor 类框架
  - 初始化所有组件（状态机、缓冲区、持久化层）
  - 定义控制标志和统计变量
  - _验收: 需求 4.1_

- [ ] 5.2 实现任务启动流程
  - 实现 start() 方法
  - 创建任务记录
  - 转换状态到 RUNNING
  - 启动工作线程
  - _验收: 需求 4.2_

- [ ] 5.3 实现步骤处理流程
  - 实现 on_step_completed() 方法
  - 检查停止标志
  - 写入步骤到缓冲区
  - _验收: 需求 4.3_

- [ ] 5.4 实现任务停止流程
  - 实现 stop() 方法
  - 设置停止标志
  - 转换状态到 STOPPING
  - 实现 _finalize_stop() 方法
  - _验收: 需求 6.1-6.7_

- [ ] 5.5 实现任务完成流程
  - 实现 on_task_completed() 方法
  - 刷新缓冲区
  - 更新最终状态
  - 清理资源
  - _验收: 需求 4.4-4.5_

- [ ] 5.6 实现资源清理
  - 实现 _cleanup() 方法
  - 停止工作线程
  - 释放内存
  - _验收: 需求 4.6_

- [ ]* 5.7 编写执行器单元测试
  - 测试完整任务执行流程
  - 测试停止流程
  - 测试错误处理
  - _验收: 需求 10.1-10.7_

### 6. 线程安全保证

- [ ] 6.1 添加线程锁
  - 为共享状态添加锁
  - 使用 threading.Lock 保护临界区
  - _验收: 需求 8.1_

- [ ] 6.2 实现线程安全队列
  - 使用 queue.Queue 进行线程间通信
  - 实现信号槽的正确连接方式
  - _验收: 需求 8.2-8.3_

- [ ] 6.3 实现原子操作
  - 使用原子操作修改状态
  - 避免竞态条件
  - _验收: 需求 8.5_

- [ ]* 6.4 编写并发测试
  - 测试多线程场景
  - 测试死锁检测
  - _验收: 需求 8.7, 10.5_

## 阶段 3: 错误处理和恢复

### 7. 实现错误处理机制

- [ ] 7.1 实现数据库错误处理
  - 添加重试逻辑（最多 3 次）
  - 实现指数退避
  - 记录错误日志
  - _验收: 需求 2.4, 7.1_

- [ ] 7.2 实现磁盘空间检查
  - 检查可用磁盘空间
  - 空间不足时停止任务
  - 通知用户
  - _验收: 需求 7.2_

- [ ] 7.3 实现崩溃恢复
  - 实现 recover_crashed_tasks() 函数
  - 启动时检测未完成任务
  - 标记为 CRASHED 状态
  - 从备份恢复数据
  - _验收: 需求 7.4-7.7_

- [ ]* 7.4 编写错误处理测试
  - 测试数据库连接失败
  - 测试磁盘空间不足
  - 测试崩溃恢复
  - _验收: 需求 10.4_

### 8. 性能优化

- [ ] 8.1 实现批量写入优化
  - 使用 executemany 批量插入
  - 优化缓冲区大小
  - _验收: 需求 9.1_

- [ ] 8.2 添加数据库索引
  - 为常用查询添加索引
  - 优化查询性能
  - _验收: 需求 9.2_

- [ ] 8.3 实现性能监控
  - 记录关键操作耗时
  - 生成性能报告
  - _验收: 需求 9.7_

- [ ]* 8.4 编写性能测试
  - 测试 1000 步骤任务
  - 测试并发任务执行
  - 生成性能基准
  - _验收: 需求 10.6_

## 阶段 4: 集成和测试

### 9. 集成到 MainWindow

- [ ] 9.1 重构 MainWindow._start_task()
  - 使用新的 TaskExecutor
  - 移除旧的异步写入逻辑
  - _验收: 需求 4.2_

- [ ] 9.2 重构 MainWindow._stop_task()
  - 使用 TaskExecutor.stop()
  - 移除旧的停止逻辑
  - _验收: 需求 6.1-6.7_

- [ ] 9.3 重构 MainWindow._on_step_completed()
  - 使用 TaskExecutor.on_step_completed()
  - 移除 QTimer 延迟写入
  - _验收: 需求 3.1-3.7_

- [ ] 9.4 重构 MainWindow._on_task_completed()
  - 使用 TaskExecutor.on_task_completed()
  - 移除旧的最终化逻辑
  - _验收: 需求 4.4-4.5_

- [ ] 9.5 添加启动时恢复
  - 在 MainWindow.__init__() 中调用 recover_crashed_tasks()
  - 显示恢复结果
  - _验收: 需求 7.4-7.7_

### 10. 数据迁移

- [ ] 10.1 编写迁移脚本
  - 备份现有数据库
  - 添加新字段
  - 修复 UNKNOWN 状态
  - _验收: 设计文档_

- [ ] 10.2 测试迁移脚本
  - 使用测试数据验证
  - 确保数据完整性
  - _验收: 设计文档_

- [ ] 10.3 编写回滚脚本
  - 实现回滚到旧版本的逻辑
  - 测试回滚功能
  - _验收: 架构约束_

### 11. 端到端测试

- [ ]* 11.1 测试正常任务执行
  - 执行完整任务
  - 验证所有步骤已保存
  - 验证状态为 SUCCESS
  - _验收: 需求 1-10_

- [ ]* 11.2 测试停止任务
  - 执行任务并停止
  - 验证所有步骤已保存
  - 验证状态为 STOPPED
  - _验收: 需求 6.1-6.7_

- [ ]* 11.3 测试快速停止
  - 启动任务后立即停止
  - 验证数据不丢失
  - _验收: 需求 6.1-6.7_

- [ ]* 11.4 测试错误场景
  - 模拟数据库错误
  - 模拟磁盘空间不足
  - 验证错误处理
  - _验收: 需求 7.1-7.7_

- [ ]* 11.5 测试崩溃恢复
  - 模拟系统崩溃
  - 重启应用
  - 验证数据恢复
  - _验收: 需求 7.4-7.7_

### 12. 文档和清理

- [ ] 12.1 更新 API 文档
  - 文档化所有公共接口
  - 添加使用示例
  - _验收: 非功能需求_

- [ ] 12.2 编写用户指南
  - 说明新功能
  - 说明迁移步骤
  - _验收: 非功能需求_

- [ ] 12.3 清理旧代码
  - 移除不再使用的代码
  - 清理注释
  - _验收: 非功能需求_

- [ ] 12.4 代码审查
  - 进行代码审查
  - 修复发现的问题
  - _验收: 非功能需求_

## 检查点

### 检查点 1: 核心架构完成
- 完成阶段 1 所有任务
- 所有单元测试通过
- 代码审查通过

### 检查点 2: 执行器完成
- 完成阶段 2 所有任务
- 集成测试通过
- 性能测试通过

### 检查点 3: 错误处理完成
- 完成阶段 3 所有任务
- 错误场景测试通过
- 崩溃恢复测试通过

### 检查点 4: 集成完成
- 完成阶段 4 所有任务
- 端到端测试通过
- 用户验收测试通过

## 估算

- 阶段 1: 1-2 周
- 阶段 2: 1-2 周
- 阶段 3: 1 周
- 阶段 4: 1 周

**总计**: 4-6 周

## 风险和依赖

### 风险
- 数据迁移可能失败 → 充分测试迁移脚本
- 性能可能下降 → 性能基准测试
- 引入新的 bug → 全面的测试覆盖

### 依赖
- 需要暂停新功能开发
- 需要用户配合测试
- 需要准备回滚方案
