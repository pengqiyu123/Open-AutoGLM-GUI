# AutoGLM æç¤ºè¯ä¼˜åŒ–ç³»ç»Ÿ - æ€è€ƒä¸å»ºè®®

## ä¸€ã€æ ¸å¿ƒé—®é¢˜ç†è§£

### ç”¨æˆ·éœ€æ±‚
1. **å‡è½»ç”¨æˆ·è¾“å…¥è´Ÿæ‹…**ï¼šç”¨æˆ·åªéœ€è¾“å…¥ç®€å•æè¿°ï¼ˆå¦‚"æ‰“å¼€å¾®ä¿¡å‘æ¶ˆæ¯"ï¼‰ï¼Œä¸éœ€è¦è¯¦ç»†æ­¥éª¤
2. **æé«˜æ‰§è¡ŒæˆåŠŸç‡**ï¼šé€šè¿‡ä¼˜åŒ–æç¤ºè¯ï¼Œè®©æ¨¡å‹æ›´å‡†ç¡®åœ°æ‰§è¡Œä»»åŠ¡
3. **è‡ªåŠ¨è·¯å¾„ä¼˜åŒ–**ï¼šåŒä¸€ä»»åŠ¡å¤šæ¬¡æ‰§è¡Œåï¼Œç³»ç»Ÿè‡ªåŠ¨å­¦ä¹ å¹¶ä¼˜åŒ–æ‰§è¡Œè·¯å¾„
4. **é€‚é…å°æ¨¡å‹**ï¼šé’ˆå¯¹ ZhipuAI/AutoGLM-Phone-9B (9Bå‚æ•°) çš„èƒ½åŠ›é™åˆ¶è¿›è¡Œä¼˜åŒ–

### ç°æœ‰ç³»ç»Ÿåˆ†æ
- âœ… **é»„é‡‘è·¯å¾„ç³»ç»Ÿ**ï¼šå·²æœ‰ä»»åŠ¡çº§çš„å­¦ä¹ å’ŒåŒ¹é…
- âœ… **ç»éªŒæ³¨å…¥ç³»ç»Ÿ**ï¼šå·²æœ‰é”™è¯¯ç»éªŒçš„æ³¨å…¥æœºåˆ¶
- âœ… **ä»»åŠ¡åŒ¹é…ç³»ç»Ÿ**ï¼šå·²æœ‰ç›¸ä¼¼ä»»åŠ¡åŒ¹é…èƒ½åŠ›
- âœ… **Thinkingæ—¥å¿—**ï¼šå·²æœ‰å®Œæ•´çš„æ€è€ƒè¿‡ç¨‹è®°å½•
- âŒ **ç¼ºå°‘**ï¼šè‡ªåŠ¨ä»thinkingä¸­æå–ç»éªŒ
- âŒ **ç¼ºå°‘**ï¼šå…ƒç´ çº§çš„ä½ç½®è®°å¿†
- âŒ **ç¼ºå°‘**ï¼šä»»åŠ¡è‡ªåŠ¨åˆ†è§£æœºåˆ¶

## äºŒã€æ–¹æ¡ˆè¯„ä»·

### 2.1 æ€ç»´æ·å¾„ç³»ç»Ÿï¼ˆæ–‡æ¡£æ¨èæ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹**ï¼š
1. âœ… æ€è·¯æ­£ç¡®ï¼šä»"è¢«åŠ¨å­¦ä¹ "è½¬å‘"ä¸»åŠ¨å­¦ä¹ "
2. âœ… ç²’åº¦åˆé€‚ï¼šå…ƒç´ çº§è®°å¿†æ¯”ä»»åŠ¡çº§æ›´ç»†
3. âœ… ç¬¦åˆæ¨¡å‹ç‰¹ç‚¹ï¼š9Bå°æ¨¡å‹éœ€è¦æ›´æ˜ç¡®çš„æŒ‡å¯¼

**æ½œåœ¨é—®é¢˜**ï¼š
1. âš ï¸ **Thinkingè´¨é‡ä¸ç¨³å®š**
   - 9Bæ¨¡å‹çš„thinkingå¯èƒ½ä¸å¤Ÿç»“æ„åŒ–
   - å®é™…å¯èƒ½æ˜¯"éœ€è¦æœç´¢ï¼Œæ‰¾æœç´¢æ¡†ï¼Œç‚¹å‡»"è€Œä¸æ˜¯"æœç´¢æ¡†ä½äºé¡¶éƒ¨ä¸­å¤®(500,80)"
   - **å»ºè®®**ï¼šä¼˜å…ˆä»actionä¸­æå–åæ ‡ï¼Œthinkingä½œä¸ºè¡¥å……

2. âš ï¸ **åæ ‡ç¨³å®šæ€§é—®é¢˜**
   - ä¸åŒè®¾å¤‡åˆ†è¾¨ç‡ä¸åŒï¼Œåæ ‡ä¼šå˜åŒ–
   - UIç‰ˆæœ¬æ›´æ–°å¯èƒ½å¯¼è‡´ä½ç½®å˜åŒ–
   - **å»ºè®®**ï¼šä½¿ç”¨ç›¸å¯¹ä½ç½®æè¿° + åæ ‡èŒƒå›´ï¼Œè€Œä¸æ˜¯å›ºå®šåæ ‡

3. âš ï¸ **åœºæ™¯è¯†åˆ«å‡†ç¡®æ€§**
   - "å¾®ä¿¡ä¸»é¡µ"vs"å¾®ä¿¡èŠå¤©é¡µ"å¦‚ä½•å‡†ç¡®åŒºåˆ†ï¼Ÿ
   - ä»…ä»thinkingæ–‡æœ¬è¯†åˆ«å¯èƒ½ä¸å‡†
   - **å»ºè®®**ï¼šå¤šæ¨¡æ€èåˆï¼ˆæ–‡æœ¬+æˆªå›¾åˆ†æ+åº”ç”¨çŠ¶æ€ï¼‰

4. âš ï¸ **æ•°æ®è´¨é‡ä¸å™ªéŸ³**
   - Thinkingä¸­å¯èƒ½åŒ…å«é”™è¯¯ä¿¡æ¯
   - å¦‚ä½•ç¡®ä¿æå–çš„æ·å¾„æ˜¯å¯é çš„ï¼Ÿ
   - **å»ºè®®**ï¼šå¢åŠ éªŒè¯æœºåˆ¶ï¼ˆä½¿ç”¨æ¬¡æ•°é˜ˆå€¼ã€æˆåŠŸç‡é˜ˆå€¼ã€åæ ‡ä¸€è‡´æ€§æ£€æŸ¥ï¼‰

### 2.2 æˆ‘çš„æ”¹è¿›å»ºè®®

#### æ–¹æ¡ˆAï¼šå¢å¼ºç‰ˆæ€ç»´æ·å¾„ç³»ç»Ÿï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ”¹è¿›**ï¼š
1. **å¤šæºèåˆæå–**
   ```python
   # ä¼˜å…ˆçº§ï¼šactionåæ ‡ > screenshotåˆ†æ > thinkingæ–‡æœ¬
   coords = action.get('element', [])  # æœ€å¯é 
   element_info = screenshot_analysis.get('elements', [])  # æ¬¡å¯é 
   thinking_hint = extract_from_thinking(thinking)  # è¡¥å……ä¿¡æ¯
   ```

2. **ç›¸å¯¹ä½ç½® + åæ ‡èŒƒå›´**
   ```python
   @dataclass
   class MentalShortcut:
       relative_position: str  # "é¡¶éƒ¨ä¸­å¤®"ã€"åº•éƒ¨å¯¼èˆªæ ç¬¬äºŒä¸ª"
       typical_coords: List[int]  # å‚è€ƒåæ ‡
       coord_variance: List[int]  # å…è®¸åç§»èŒƒå›´ [Â±50, Â±20]
       element_features: Dict  # {"text": "æœç´¢", "icon": "search"}
   ```

3. **æ¸è¿›å¼å­¦ä¹ **
   - ç¬¬ä¸€é˜¶æ®µï¼šåªæå–æ˜ç¡®ä¿¡æ¯ï¼ˆåæ ‡ã€åŠ¨ä½œï¼‰
   - ç¬¬äºŒé˜¶æ®µï¼šå¢åŠ åœºæ™¯è¯†åˆ«å’Œç›¸å¯¹ä½ç½®
   - ç¬¬ä¸‰é˜¶æ®µï¼šè‡ªé€‚åº”ä¼˜åŒ–å’Œåˆå¹¶

#### æ–¹æ¡ˆBï¼šåˆ†å±‚æç¤ºè¯ç³»ç»Ÿï¼ˆè¡¥å……æ–¹æ¡ˆï¼‰

**ä¸‰å±‚æ¶æ„**ï¼š
```
Layer 1 (ç”¨æˆ·å±‚): "å‘å¾®ä¿¡ç»™å¼ ä¸‰"
    â†“ æ„å›¾è¯†åˆ« + å‚æ•°æå–
Layer 2 (ä»»åŠ¡å±‚): "1.æ‰“å¼€å¾®ä¿¡ 2.æ‰¾åˆ°å¼ ä¸‰ 3.å‘é€æ¶ˆæ¯"
    â†“ ä»»åŠ¡åˆ†è§£ + é»„é‡‘è·¯å¾„åŒ¹é…
Layer 3 (æ“ä½œå±‚): "Launchå¾®ä¿¡ â†’ Tapæœç´¢ â†’ Typeå¼ ä¸‰ â†’ Tapè”ç³»äºº â†’ ..."
    â†“ æ€ç»´æ·å¾„æ³¨å…¥
æ‰§è¡Œå±‚: å…·ä½“åæ ‡å’ŒåŠ¨ä½œ
```

**å®ç°è¦ç‚¹**ï¼š
- åˆ©ç”¨ç°æœ‰çš„é»„é‡‘è·¯å¾„ `correct_path` è¿›è¡Œä»»åŠ¡åˆ†è§£
- åœ¨æ¯æ­¥æ‰§è¡Œæ—¶åŠ¨æ€æ³¨å…¥æ€ç»´æ·å¾„
- ç»“åˆå†å²ç»éªŒä¼˜åŒ–æç¤ºè¯

## ä¸‰ã€æŠ€æœ¯å®ç°å»ºè®®

### 3.1 å¢å¼ºç‰ˆæ€ç»´æ·å¾„æå–å™¨

```python
class EnhancedThinkingExtractor:
    """å¢å¼ºç‰ˆæ€ç»´æ·å¾„æå–å™¨ - å¤šæºèåˆ"""
    
    def extract_from_step(self, step_data: Dict) -> Optional[MentalShortcut]:
        """
        ä»æ­¥éª¤æ•°æ®ä¸­æå–æ·å¾„ï¼ˆå¤šæºèåˆï¼‰
        
        Args:
            step_data: {
                'thinking': str,
                'action': dict,
                'screenshot_path': str,
                'screenshot_analysis': dict,  # å¦‚æœæœ‰OCR/UIåˆ†æ
                'app': str,
                'success': bool
            }
        """
        # 1. ä»actionä¸­æå–ï¼ˆæœ€å¯é ï¼‰
        coords = step_data['action'].get('element', [])
        action_type = step_data['action'].get('action', '')
        
        # 2. ä»screenshot_analysisä¸­æå–å…ƒç´ ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        element_info = None
        if step_data.get('screenshot_analysis'):
            element_info = self._extract_from_analysis(
                step_data['screenshot_analysis']
            )
        
        # 3. ä»thinkingä¸­æå–è¡¥å……ä¿¡æ¯
        thinking_info = self._extract_from_thinking(step_data['thinking'])
        
        # 4. èåˆå¤šæºä¿¡æ¯
        return self._merge_extracted_info(
            coords, action_type, element_info, thinking_info
        )
```

### 3.2 è‡ªé€‚åº”æ·å¾„æ³¨å…¥å™¨

```python
class AdaptiveShortcutInjector:
    """è‡ªé€‚åº”æ·å¾„æ³¨å…¥å™¨ - å¸¦éªŒè¯å’Œå›é€€"""
    
    def inject_shortcuts(
        self, 
        app: str, 
        scene: str,
        min_confidence: float = 0.8
    ) -> str:
        """
        æ³¨å…¥æ€ç»´æ·å¾„ï¼ˆå¸¦è´¨é‡éªŒè¯ï¼‰
        
        Args:
            app: å½“å‰åº”ç”¨
            scene: å½“å‰åœºæ™¯
            min_confidence: æœ€ä½ç½®ä¿¡åº¦é˜ˆå€¼
            
        Returns:
            æ ¼å¼åŒ–çš„æç¤ºè¯ï¼Œå¦‚æœæ²¡æœ‰å¯é æ·å¾„åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
        """
        shortcuts = self.repo.find_by_app_scene(app, scene)
        
        if not shortcuts:
            return ""  # æ²¡æœ‰æ·å¾„ï¼Œæ¨¡å‹è‡ªå·±åˆ†æ
        
        # æŒ‰ç½®ä¿¡åº¦æ’åº
        shortcuts.sort(key=lambda x: x.confidence, reverse=True)
        
        # åªæ³¨å…¥é«˜ç½®ä¿¡åº¦çš„æ·å¾„
        high_confidence = [
            s for s in shortcuts 
            if s.confidence >= min_confidence 
            and s.usage_count >= 3  # è‡³å°‘ä½¿ç”¨3æ¬¡
            and s.success_count / s.usage_count >= 0.8  # æˆåŠŸç‡ >= 80%
        ]
        
        if not high_confidence:
            return ""  # æ²¡æœ‰é«˜ç½®ä¿¡åº¦çš„æ·å¾„ï¼Œä¸æ³¨å…¥
        
        # æ„å»ºæç¤ºè¯
        prompt = self._build_prompt(high_confidence)
        
        # æ·»åŠ å…è´£å£°æ˜ï¼ˆé€‚é…å°æ¨¡å‹ï¼‰
        prompt += "\n\nâš ï¸ æ³¨æ„ï¼šä»¥ä¸Šä½ç½®ä»…ä¾›å‚è€ƒï¼Œå¦‚æœç•Œé¢æœ‰å˜åŒ–æˆ–æ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¯·é‡æ–°åˆ†æç•Œé¢ã€‚"
        
        return prompt
```

### 3.3 ç»Ÿä¸€ç»éªŒç³»ç»Ÿ

```python
class UnifiedExperienceSystem:
    """ç»Ÿä¸€ç»éªŒç³»ç»Ÿ - æ•´åˆé»„é‡‘è·¯å¾„å’Œæ€ç»´æ·å¾„"""
    
    def build_enhanced_prompt(
        self, 
        task: str,
        matched_golden_path: Optional[Dict],
        current_app: str,
        current_scene: str = ""
    ) -> str:
        """
        æ„å»ºå¢å¼ºæç¤ºè¯ï¼ˆæ•´åˆå¤šç§ç»éªŒï¼‰
        
        ä¼˜å…ˆçº§ï¼š
        1. é»„é‡‘è·¯å¾„çš„ä»»åŠ¡çº§æŒ‡å¯¼ï¼ˆæ­¥éª¤ã€çº¦æŸï¼‰
        2. æ€ç»´æ·å¾„çš„å…ƒç´ çº§æŒ‡å¯¼ï¼ˆä½ç½®ã€åæ ‡ï¼‰
        3. å†å²é”™è¯¯ç»éªŒï¼ˆé¿å…é‡å¤é”™è¯¯ï¼‰
        """
        prompt_parts = [task]
        
        # ========== Layer 1: é»„é‡‘è·¯å¾„ï¼ˆä»»åŠ¡çº§æŒ‡å¯¼ï¼‰==========
        if matched_golden_path:
            # ä»»åŠ¡æ­¥éª¤åˆ†è§£
            if matched_golden_path.get('correct_path'):
                prompt_parts.append("\n\nğŸ“‹ ä»»åŠ¡åˆ†è§£ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š")
                for i, step in enumerate(matched_golden_path['correct_path'], 1):
                    prompt_parts.append(f"æ­¥éª¤{i}: {step}")
            
            # ç¦æ­¢æ“ä½œ
            if matched_golden_path.get('forbidden'):
                prompt_parts.append("\n\nâŒ ç¦æ­¢æ“ä½œï¼š")
                for f in matched_golden_path['forbidden']:
                    prompt_parts.append(f"- {f}")
            
            # å…³é”®æç¤º
            if matched_golden_path.get('hints'):
                prompt_parts.append("\n\nğŸ’¡ å…³é”®æç¤ºï¼š")
                for h in matched_golden_path['hints']:
                    prompt_parts.append(f"- {h}")
        
        # ========== Layer 2: æ€ç»´æ·å¾„ï¼ˆå…ƒç´ çº§æŒ‡å¯¼ï¼‰==========
        shortcuts = self.shortcut_repo.find_by_app_scene(current_app, current_scene)
        if shortcuts:
            prompt_parts.append(f"\n\nğŸ“ ç•Œé¢å…ƒç´ ä½ç½®æç¤ºï¼ˆ{current_app} - {current_scene}ï¼‰ï¼š")
            for sc in shortcuts[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                coord_str = f"({sc.typical_coords[0]},{sc.typical_coords[1]})"
                prompt_parts.append(
                    f"- {sc.element}: {sc.location_hint}ï¼Œå‚è€ƒåæ ‡{coord_str}"
                )
        
        return "\n".join(prompt_parts)
```

## å››ã€å®æ–½å»ºè®®

### 4.1 åˆ†é˜¶æ®µå®æ–½ç­–ç•¥

**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æå–ï¼ˆä¿å®ˆç­–ç•¥ï¼‰**
- âœ… åªæå–æ˜ç¡®çš„ä¿¡æ¯ï¼ˆåæ ‡ã€åŠ¨ä½œç±»å‹ï¼‰
- âœ… åªå­˜å‚¨é«˜ç½®ä¿¡åº¦çš„æ·å¾„ï¼ˆæˆåŠŸç‡ > 90%ï¼Œä½¿ç”¨æ¬¡æ•° > 3ï¼‰
- âœ… å…ˆæ‰‹åŠ¨éªŒè¯ï¼Œå†è‡ªåŠ¨åº”ç”¨
- âœ… ä¸ç°æœ‰é»„é‡‘è·¯å¾„ç³»ç»Ÿå¹¶è¡Œè¿è¡Œ

**ç¬¬äºŒé˜¶æ®µï¼šæ™ºèƒ½æå–ï¼ˆæ‰©å±•ç­–ç•¥ï¼‰**
- âœ… å¢åŠ åœºæ™¯è¯†åˆ«ï¼ˆåŸºäºåº”ç”¨çŠ¶æ€ + æˆªå›¾ç‰¹å¾ï¼‰
- âœ… å¢åŠ ç›¸å¯¹ä½ç½®æè¿°ï¼ˆ"é¡¶éƒ¨ä¸­å¤®"ã€"åº•éƒ¨ç¬¬äºŒä¸ª"ï¼‰
- âœ… å¢åŠ å…ƒç´ ç‰¹å¾åŒ¹é…ï¼ˆæ–‡æœ¬ã€å›¾æ ‡ï¼‰
- âœ… è‡ªåŠ¨åˆå¹¶ç›¸ä¼¼æ·å¾„

**ç¬¬ä¸‰é˜¶æ®µï¼šè‡ªé€‚åº”ä¼˜åŒ–ï¼ˆå®Œå–„ç­–ç•¥ï¼‰**
- âœ… è‡ªåŠ¨æ·˜æ±°ä½è´¨é‡æ·å¾„ï¼ˆæˆåŠŸç‡ < 70%ï¼‰
- âœ… æ”¯æŒå¤šè®¾å¤‡é€‚é…ï¼ˆåæ ‡èŒƒå›´è‡ªé€‚åº”ï¼‰
- âœ… è·¯å¾„è‡ªåŠ¨ä¼˜åŒ–ï¼ˆè¯†åˆ«å†—ä½™æ­¥éª¤ï¼‰

### 4.2 ä¸ç°æœ‰ç³»ç»Ÿçš„æ•´åˆ

**æ•´åˆç‚¹**ï¼š
1. **AgentRunner.run_task()** - åœ¨ä»»åŠ¡å¼€å§‹æ—¶æ³¨å…¥æ€ç»´æ·å¾„
2. **PhoneAgent._execute_step()** - åœ¨æ¯æ­¥æ‰§è¡Œæ—¶åŠ¨æ€è°ƒæ•´æç¤ºè¯
3. **GoldenPathExtractor** - æå–é»„é‡‘è·¯å¾„æ—¶åŒæ—¶æå–æ€ç»´æ·å¾„
4. **TaskMatcher** - åŒ¹é…ä»»åŠ¡æ—¶åŒæ—¶åŒ¹é…åœºæ™¯å’Œå…ƒç´ 

**æ•°æ®æµ**ï¼š
```
ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ 
  â†’ æå–thinking + action + screenshot
  â†’ ç”Ÿæˆæ€ç»´æ·å¾„
  â†’ å­˜å‚¨åˆ°æ•°æ®åº“
  â†’ ä¸‹æ¬¡æ‰§è¡Œæ—¶åŒ¹é…åœºæ™¯
  â†’ æ³¨å…¥åˆ°æç¤ºè¯
  â†’ æé«˜æ‰§è¡Œæ•ˆç‡
```

### 4.3 å…³é”®æ³¨æ„äº‹é¡¹

1. **æ•°æ®è´¨é‡ä¼˜å…ˆ**
   - å®å¯å°‘æå–ï¼Œä¹Ÿä¸è¦æå–é”™è¯¯ä¿¡æ¯
   - è®¾ç½®ä¸¥æ ¼çš„éªŒè¯é˜ˆå€¼
   - å®šæœŸæ¸…ç†ä½è´¨é‡æ•°æ®

2. **é€‚é…å°æ¨¡å‹**
   - æç¤ºè¯è¦ç®€æ´æ˜ç¡®
   - é¿å…ä¿¡æ¯è¿‡è½½
   - æä¾›å›é€€æœºåˆ¶ï¼ˆæ‰¾ä¸åˆ°æ·å¾„æ—¶æ¨¡å‹è‡ªå·±åˆ†æï¼‰

3. **æ¸è¿›å¼ä¼˜åŒ–**
   - ä¸è¦ä¸€æ¬¡æ€§å®ç°æ‰€æœ‰åŠŸèƒ½
   - å…ˆéªŒè¯æ ¸å¿ƒåŠŸèƒ½çš„æœ‰æ•ˆæ€§
   - æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´ç­–ç•¥

## äº”ã€æ€»ç»“

### æ ¸å¿ƒä»·å€¼
é€šè¿‡æ€ç»´æ·å¾„ç³»ç»Ÿï¼Œè®©æ¨¡å‹å½¢æˆ"ä½ç½®è®°å¿†"ï¼Œå‡å°‘é‡å¤åˆ†æï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚

### å…³é”®æˆåŠŸå› ç´ 
1. âœ… **æ•°æ®è´¨é‡**ï¼šç¡®ä¿æå–çš„æ·å¾„æ˜¯å¯é çš„
2. âœ… **å¤šæºèåˆ**ï¼šä¸ä¾èµ–å•ä¸€æ•°æ®æº
3. âœ… **æ¸è¿›ä¼˜åŒ–**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œé€æ­¥å®Œå–„
4. âœ… **ç³»ç»Ÿæ•´åˆ**ï¼šä¸ç°æœ‰é»„é‡‘è·¯å¾„ç³»ç»ŸååŒå·¥ä½œ

### é¢„æœŸæ•ˆæœ
- ğŸ“ˆ **æ‰§è¡ŒæˆåŠŸç‡æå‡**ï¼šé€šè¿‡ä½ç½®æç¤ºå‡å°‘é”™è¯¯
- âš¡ **æ‰§è¡Œé€Ÿåº¦æå‡**ï¼šå‡å°‘ä¸å¿…è¦çš„ç•Œé¢åˆ†æ
- ğŸ¯ **ç”¨æˆ·è´Ÿæ‹…é™ä½**ï¼šç³»ç»Ÿè‡ªåŠ¨å­¦ä¹ ï¼Œç”¨æˆ·åªéœ€ç®€å•è¾“å…¥
- ğŸ”„ **æŒç»­ä¼˜åŒ–**ï¼šæ¯æ¬¡æ‰§è¡Œéƒ½èƒ½ç§¯ç´¯ç»éªŒ

### é£é™©æ§åˆ¶
- âš ï¸ åæ ‡å˜åŒ–ï¼šä½¿ç”¨ç›¸å¯¹ä½ç½® + åæ ‡èŒƒå›´
- âš ï¸ åœºæ™¯è¯¯åˆ¤ï¼šå¤šæ¨¡æ€èåˆè¯†åˆ«
- âš ï¸ æ•°æ®å™ªéŸ³ï¼šä¸¥æ ¼çš„éªŒè¯æœºåˆ¶
- âš ï¸ æ¨¡å‹èƒ½åŠ›ï¼šé€‚é…å°æ¨¡å‹ï¼Œæä¾›å›é€€æœºåˆ¶

---

## å…­ã€å¯¹æ–‡æ¡£"ç°çŠ¶åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ.md"çš„è¿›ä¸€æ­¥æ€è€ƒ

### 6.1 å…³äºæ–‡æ¡£ä¸­"ä¹ã€ä¸ ChatGPT çš„äº¤æµè®¨è®º"ç« èŠ‚çš„æ€è€ƒ

æ–‡æ¡£ä¸­è®°å½•äº†ChatGPTæå‡ºçš„é—®é¢˜å’ŒKiroçš„å›åº”ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è®¨è®ºè¿‡ç¨‹ã€‚æˆ‘åœ¨æ­¤åŸºç¡€ä¸Šæœ‰ä»¥ä¸‹è¡¥å……æ€è€ƒï¼š

#### æ€è€ƒ1ï¼šå…³äº"å¤šæºèåˆæå–"çš„ä¼˜å…ˆçº§

æ–‡æ¡£ä¸­æåˆ°ï¼š
> ä¼˜å…ˆçº§ï¼šactionåæ ‡ > thinkingæ–‡æœ¬

**æˆ‘çš„è¡¥å……**ï¼š
è¿™ä¸ªä¼˜å…ˆçº§æ˜¯æ­£ç¡®çš„ï¼Œä½†éœ€è¦æ›´ç»†åŒ–çš„ç­–ç•¥ï¼š

```python
# æ•°æ®æºå¯é æ€§æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
1. action['element'] - æ‰§è¡Œæ—¶çš„å®é™…åæ ‡ï¼ˆ100%å‡†ç¡®ï¼‰
2. screenshot_analysis - OCR/UIåˆ†æç»“æœï¼ˆ90%å‡†ç¡®ï¼Œä½†å¯èƒ½æ²¡æœ‰ï¼‰
3. thinkingä¸­çš„åæ ‡ - æ¨¡å‹è‡ªå·±åˆ†æçš„åæ ‡ï¼ˆ70%å‡†ç¡®ï¼‰
4. thinkingä¸­çš„ä½ç½®æè¿° - "é¡¶éƒ¨ä¸­å¤®"ç­‰ï¼ˆ50%å‡†ç¡®ï¼Œä½†æ›´ç¨³å®šï¼‰

# æå–ç­–ç•¥
def extract_coords(self, step_data):
    # 1. ä¼˜å…ˆä»actionè·å–ï¼ˆæœ€å¯é ï¼‰
    if action_coords := step_data['action'].get('element'):
        return action_coords, confidence=1.0
    
    # 2. ä»screenshot_analysisè·å–ï¼ˆå¦‚æœæœ‰ï¼‰
    if analysis_coords := self._extract_from_analysis(step_data.get('screenshot_analysis')):
        return analysis_coords, confidence=0.9
    
    # 3. ä»thinkingä¸­æå–åæ ‡ï¼ˆæ¬¡å¯é ï¼‰
    if thinking_coords := self._extract_coords_from_thinking(step_data['thinking']):
        return thinking_coords, confidence=0.7
    
    # 4. å¦‚æœéƒ½æ²¡æœ‰ï¼Œè‡³å°‘æå–ä½ç½®æè¿°ï¼ˆç›¸å¯¹ä½ç½®ï¼‰
    if location_hint := self._extract_location_hint(step_data['thinking']):
        return None, location_hint, confidence=0.5
    
    return None, None, confidence=0.0
```

#### æ€è€ƒ2ï¼šå…³äº"å½’ä¸€åŒ–åæ ‡ç³»ç»Ÿ"çš„è¿›ä¸€æ­¥ä¼˜åŒ–

æ–‡æ¡£ä¸­æåˆ°ç³»ç»Ÿå·²ç»ä½¿ç”¨0-999çš„å½’ä¸€åŒ–åæ ‡ç³»ç»Ÿï¼Œè¿™æ˜¯å¥½çš„ã€‚ä½†è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

```python
@dataclass
class MentalShortcut:
    # åŸºç¡€åæ ‡ï¼ˆå½’ä¸€åŒ–0-999ï¼‰
    typical_coords: List[int]  # [500, 80]
    
    # åæ ‡æ–¹å·®ï¼ˆå…è®¸åç§»èŒƒå›´ï¼‰
    coord_variance: List[int]  # [50, 20] è¡¨ç¤º Â±50, Â±20
    
    # ç›¸å¯¹ä½ç½®æè¿°ï¼ˆæ›´ç¨³å®šï¼‰
    relative_position: str  # "é¡¶éƒ¨ä¸­å¤®"ã€"åº•éƒ¨å¯¼èˆªæ ç¬¬äºŒä¸ª"
    
    # å…ƒç´ ç‰¹å¾ï¼ˆç”¨äºåŒ¹é…ï¼‰
    element_features: Dict  # {
    #     "text": "æœç´¢",           # æ–‡æœ¬å†…å®¹
    #     "icon": "search",         # å›¾æ ‡ç±»å‹
    #     "position": "top_center",  # ä½ç½®æ ‡ç­¾
    #     "size": "large"            # å¤§å°æ ‡ç­¾
    # }
    
    # é€‚é…ç­–ç•¥
    adaptation_strategy: str  # "fixed" | "relative" | "ocr_match" | "hybrid"
```

**å…³é”®æ”¹è¿›**ï¼š
- å½“åæ ‡å˜åŒ–è¾ƒå¤§æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ç›¸å¯¹ä½ç½®æè¿°
- å½“ç›¸å¯¹ä½ç½®ä¹Ÿä¸å‡†ç¡®æ—¶ï¼Œä½¿ç”¨å…ƒç´ ç‰¹å¾åŒ¹é…ï¼ˆOCRæ–‡æœ¬ã€å›¾æ ‡ç±»å‹ï¼‰
- å½¢æˆå¤šå±‚æ¬¡çš„å›é€€æœºåˆ¶

#### æ€è€ƒ3ï¼šå…³äº"åœºæ™¯è¯†åˆ«"çš„æ”¹è¿›æ–¹æ¡ˆ

æ–‡æ¡£ä¸­æåˆ°åœºæ™¯è¯†åˆ«å¯èƒ½ä¸å‡†ç¡®ï¼Œå»ºè®®ç»“åˆæˆªå›¾ç‰¹å¾ã€‚æˆ‘çš„è¿›ä¸€æ­¥æ€è€ƒï¼š

```python
class SceneIdentifier:
    """åœºæ™¯è¯†åˆ«å™¨ - å¤šæ¨¡æ€èåˆ"""
    
    def identify_scene(
        self, 
        app: str,
        thinking: str,
        screenshot_path: str,
        current_app_state: Dict
    ) -> str:
        """
        å¤šæ¨¡æ€åœºæ™¯è¯†åˆ«
        
        ä¼˜å…ˆçº§ï¼š
        1. åº”ç”¨çŠ¶æ€ï¼ˆæœ€å¯é ï¼‰- ä»ç³»ç»ŸAPIè·å–
        2. æˆªå›¾ç‰¹å¾ï¼ˆæ¬¡å¯é ï¼‰- è§†è§‰åˆ†æ
        3. thinkingæ–‡æœ¬ï¼ˆè¡¥å……ï¼‰- æ–‡æœ¬åˆ†æ
        """
        scene_scores = {}
        
        # 1. ä»åº”ç”¨çŠ¶æ€è¯†åˆ«ï¼ˆå¦‚æœæœ‰ï¼‰
        if app_state := current_app_state.get('activity'):
            # ä¾‹å¦‚ï¼šcom.tencent.mm.ui.LauncherUI -> "ä¸»é¡µ"
            scene_from_state = self._parse_activity(app_state)
            scene_scores[scene_from_state] = 0.9
        
        # 2. ä»æˆªå›¾ç‰¹å¾è¯†åˆ«
        screenshot_features = self._analyze_screenshot(screenshot_path)
        if scene_from_screenshot := self._match_scene_by_features(screenshot_features):
            scene_scores[scene_from_screenshot] = scene_scores.get(scene_from_screenshot, 0) + 0.7
        
        # 3. ä»thinkingæ–‡æœ¬è¯†åˆ«ï¼ˆè¡¥å……ï¼‰
        if scene_from_thinking := self._extract_scene_from_thinking(thinking):
            scene_scores[scene_from_thinking] = scene_scores.get(scene_from_thinking, 0) + 0.5
        
        # è¿”å›å¾—åˆ†æœ€é«˜çš„åœºæ™¯
        if scene_scores:
            return max(scene_scores.items(), key=lambda x: x[1])[0]
        
        return "æœªçŸ¥é¡µé¢"
    
    def _analyze_screenshot(self, screenshot_path: str) -> Dict:
        """åˆ†ææˆªå›¾ç‰¹å¾"""
        # å¯ä»¥æ£€æµ‹ï¼š
        # - åº•éƒ¨å¯¼èˆªæ æ˜¯å¦å­˜åœ¨ï¼ˆä¸»é¡µç‰¹å¾ï¼‰
        # - è¾“å…¥æ¡†æ˜¯å¦å­˜åœ¨ï¼ˆæœç´¢/èŠå¤©é¡µç‰¹å¾ï¼‰
        # - ç‰¹å®šUIå…ƒç´ ï¼ˆå¦‚å¾®ä¿¡çš„"+"æŒ‰é’®ï¼‰
        # - é¢œè‰²åˆ†å¸ƒï¼ˆä¸åŒé¡µé¢é¢œè‰²ä¸åŒï¼‰
        return {
            "has_bottom_nav": True,
            "has_input_field": False,
            "has_specific_elements": ["search_icon"],
            "color_distribution": {...}
        }
```

#### æ€è€ƒ4ï¼šå…³äº"ç»Ÿä¸€ç»éªŒç³»ç»Ÿ"çš„æ•´åˆç­–ç•¥

æ–‡æ¡£ä¸­æåˆ°äº†ç»Ÿä¸€ç»éªŒç³»ç»Ÿï¼Œæˆ‘è®¤ä¸ºå¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–æ•´åˆç­–ç•¥ï¼š

```python
class UnifiedExperienceSystem:
    """ç»Ÿä¸€ç»éªŒç³»ç»Ÿ - ç»†åŒ–æ•´åˆç­–ç•¥"""
    
    def build_enhanced_prompt(
        self,
        task: str,
        matched_golden_path: Optional[Dict],
        current_app: str,
        current_scene: str,
        step_num: int = 1
    ) -> str:
        """
        æ„å»ºå¢å¼ºæç¤ºè¯ï¼ˆåˆ†æ­¥éª¤ä¼˜åŒ–ï¼‰
        
        å…³é”®æ”¹è¿›ï¼š
        - æ ¹æ®å½“å‰æ­¥éª¤åŠ¨æ€è°ƒæ•´æç¤ºè¯
        - é¿å…ä¿¡æ¯è¿‡è½½ï¼ˆå°æ¨¡å‹é™åˆ¶ï¼‰
        - ä¼˜å…ˆçº§æ˜ç¡®
        """
        prompt_parts = [task]
        
        # ========== æ­¥éª¤1-2ï¼šä»»åŠ¡çº§æŒ‡å¯¼ï¼ˆé»„é‡‘è·¯å¾„ï¼‰==========
        if step_num <= 2 and matched_golden_path:
            if correct_path := matched_golden_path.get('correct_path'):
                prompt_parts.append("\n\nğŸ“‹ ä»»åŠ¡æ­¥éª¤ï¼š")
                # åªæ˜¾ç¤ºå‰3æ­¥ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
                for i, step in enumerate(correct_path[:3], 1):
                    prompt_parts.append(f"æ­¥éª¤{i}: {step}")
                if len(correct_path) > 3:
                    prompt_parts.append(f"... å…±{len(correct_path)}æ­¥")
            
            if forbidden := matched_golden_path.get('forbidden'):
                prompt_parts.append("\n\nâŒ ç¦æ­¢æ“ä½œï¼š")
                for f in forbidden[:2]:  # æœ€å¤š2æ¡
                    prompt_parts.append(f"- {f}")
        
        # ========== æ­¥éª¤3+ï¼šå…ƒç´ çº§æŒ‡å¯¼ï¼ˆæ€ç»´æ·å¾„ï¼‰==========
        if step_num >= 3:
            shortcuts = self.shortcut_repo.find_by_app_scene(current_app, current_scene)
            if shortcuts:
                prompt_parts.append(f"\n\nğŸ“ å½“å‰é¡µé¢å…ƒç´ ä½ç½®æç¤ºï¼š")
                # åªæ˜¾ç¤º3ä¸ªæœ€ç›¸å…³çš„æ·å¾„
                for sc in shortcuts[:3]:
                    coord_str = f"({sc.typical_coords[0]},{sc.typical_coords[1]})"
                    prompt_parts.append(
                        f"- {sc.element}: {sc.location_hint}ï¼Œå‚è€ƒ{coord_str}"
                    )
        
        # ========== å…³é”®æç¤ºï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰==========
        if matched_golden_path and (hints := matched_golden_path.get('hints')):
            prompt_parts.append("\n\nğŸ’¡ å…³é”®æç¤ºï¼š")
            for h in hints[:1]:  # åªæ˜¾ç¤º1æ¡æœ€é‡è¦çš„
                prompt_parts.append(f"- {h}")
        
        return "\n".join(prompt_parts)
```

**å…³é”®æ”¹è¿›ç‚¹**ï¼š
1. **åˆ†æ­¥éª¤ä¼˜åŒ–**ï¼šä¸åŒæ­¥éª¤æ˜¾ç¤ºä¸åŒä¿¡æ¯ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
2. **ä¿¡æ¯é‡æ§åˆ¶**ï¼šé™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé€‚é…å°æ¨¡å‹
3. **ä¼˜å…ˆçº§æ˜ç¡®**ï¼šä»»åŠ¡çº§æŒ‡å¯¼ä¼˜å…ˆï¼Œå…ƒç´ çº§æŒ‡å¯¼è¡¥å……

### 6.2 å…³äº"æ¸è¿›å¼å­¦ä¹ "çš„è¿›ä¸€æ­¥ç»†åŒ–

æ–‡æ¡£ä¸­æåˆ°äº†æ¸è¿›å¼å­¦ä¹ ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥æ›´ç»†åŒ–ï¼š

**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æå–ï¼ˆä¿å®ˆç­–ç•¥ï¼‰**
```python
# åªæå–æœ€å¯é çš„ä¿¡æ¯
- âœ… åæ ‡ï¼šå¿…é¡»ä»actionä¸­è·å–ï¼ˆ100%å‡†ç¡®ï¼‰
- âœ… åŠ¨ä½œç±»å‹ï¼šå¿…é¡»ä»actionä¸­è·å–
- âœ… åº”ç”¨åï¼šä»current_appè·å–
- âŒ åœºæ™¯ï¼šæš‚ä¸æå–ï¼ˆå‡†ç¡®æ€§ä½ï¼‰
- âŒ ä½ç½®æè¿°ï¼šæš‚ä¸æå–ï¼ˆéœ€è¦éªŒè¯ï¼‰

# éªŒè¯æ¡ä»¶ï¼ˆéå¸¸ä¸¥æ ¼ï¼‰
- ä½¿ç”¨æ¬¡æ•° >= 5æ¬¡
- æˆåŠŸç‡ >= 95%
- åæ ‡æ–¹å·® < 30ï¼ˆåæ ‡ç¨³å®šï¼‰
```

**ç¬¬äºŒé˜¶æ®µï¼šæ™ºèƒ½æå–ï¼ˆæ‰©å±•ç­–ç•¥ï¼‰**
```python
# å¢åŠ æ›´å¤šä¿¡æ¯
- âœ… åœºæ™¯è¯†åˆ«ï¼šåŸºäºåº”ç”¨çŠ¶æ€ + æˆªå›¾ç‰¹å¾
- âœ… ç›¸å¯¹ä½ç½®æè¿°ï¼šä»thinkingä¸­æå–
- âœ… å…ƒç´ ç‰¹å¾ï¼šOCRæ–‡æœ¬ã€å›¾æ ‡ç±»å‹
- âœ… è‡ªåŠ¨åˆå¹¶ï¼šç›¸ä¼¼æ·å¾„åˆå¹¶

# éªŒè¯æ¡ä»¶ï¼ˆæ”¾å®½ï¼‰
- ä½¿ç”¨æ¬¡æ•° >= 3æ¬¡
- æˆåŠŸç‡ >= 80%
- åæ ‡æ–¹å·® < 50
```

**ç¬¬ä¸‰é˜¶æ®µï¼šè‡ªé€‚åº”ä¼˜åŒ–ï¼ˆå®Œå–„ç­–ç•¥ï¼‰**
```python
# å®Œå…¨è‡ªåŠ¨åŒ–
- âœ… è‡ªåŠ¨æ·˜æ±°ä½è´¨é‡æ·å¾„
- âœ… å¤šè®¾å¤‡é€‚é…ï¼ˆåæ ‡èŒƒå›´è‡ªé€‚åº”ï¼‰
- âœ… è·¯å¾„è‡ªåŠ¨ä¼˜åŒ–
- âœ… åœºæ™¯è‡ªåŠ¨è¯†åˆ«å’Œæ›´æ–°

# éªŒè¯æ¡ä»¶ï¼ˆè‡ªé€‚åº”ï¼‰
- æ ¹æ®åº”ç”¨ç±»å‹åŠ¨æ€è°ƒæ•´é˜ˆå€¼
- æ ¹æ®ä½¿ç”¨é¢‘ç‡åŠ¨æ€è°ƒæ•´æƒé‡
```

### 6.3 å…³äº"ä»»åŠ¡åˆ†è§£"ä¸"æ€ç»´æ·å¾„"çš„ååŒ

æ–‡æ¡£ä¸­æåˆ°äº†åˆ†å±‚æç¤ºè¯ç³»ç»Ÿï¼Œæˆ‘è®¤ä¸ºå¯ä»¥è¿›ä¸€æ­¥æ˜ç¡®ä¸¤è€…çš„ååŒå…³ç³»ï¼š

```
ç”¨æˆ·è¾“å…¥ï¼š"å‘å¾®ä¿¡ç»™å¼ ä¸‰"
    â†“
ã€Layer 1 â†’ Layer 2ï¼šä»»åŠ¡åˆ†è§£ã€‘
åˆ©ç”¨é»„é‡‘è·¯å¾„çš„correct_pathï¼š
"1.æ‰“å¼€å¾®ä¿¡ 2.æ‰¾åˆ°æœç´¢å…¥å£ 3.æœç´¢å¼ ä¸‰ 4.ç‚¹å‡»è”ç³»äºº 5.è¾“å…¥æ¶ˆæ¯ 6.å‘é€"
    â†“
ã€Layer 2 â†’ Layer 3ï¼šå…ƒç´ å®šä½ã€‘
åˆ©ç”¨æ€ç»´æ·å¾„ï¼š
- æ­¥éª¤2ï¼šæœç´¢å…¥å£åœ¨é¡¶éƒ¨ä¸­å¤®(500,80)
- æ­¥éª¤3ï¼šæœç´¢æ¡†åœ¨é¡¶éƒ¨ï¼Œè¾“å…¥åç‚¹å‡»æœç´¢æŒ‰é’®
- æ­¥éª¤4ï¼šè”ç³»äººåˆ—è¡¨åœ¨ä¸­é—´åŒºåŸŸ
- æ­¥éª¤6ï¼šå‘é€æŒ‰é’®åœ¨è¾“å…¥æ¡†å³ä¾§(900,950)
    â†“
ã€æ‰§è¡Œã€‘
æ¨¡å‹æŒ‰ç…§æ­¥éª¤æ‰§è¡Œï¼Œæ¯æ­¥éƒ½æœ‰ä½ç½®æç¤ºï¼Œå‡å°‘åˆ†ææ—¶é—´
```

**å…³é”®ååŒç‚¹**ï¼š
1. **é»„é‡‘è·¯å¾„æä¾›"åšä»€ä¹ˆ"**ï¼šä»»åŠ¡æ­¥éª¤ã€ç¦æ­¢æ“ä½œã€å…³é”®æç¤º
2. **æ€ç»´æ·å¾„æä¾›"åœ¨å“ªé‡Œ"**ï¼šå…ƒç´ ä½ç½®ã€åæ ‡ã€ç›¸å¯¹ä½ç½®
3. **ä¸¤è€…ç»“åˆ**ï¼šæ—¢æœ‰æ­¥éª¤æŒ‡å¯¼ï¼Œåˆæœ‰ä½ç½®æç¤ºï¼Œæé«˜æˆåŠŸç‡

### 6.4 å…³äº"æ•°æ®è´¨é‡"çš„è¿›ä¸€æ­¥æ€è€ƒ

æ–‡æ¡£ä¸­æåˆ°äº†æ•°æ®è´¨é‡çš„é‡è¦æ€§ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥å¢åŠ æ›´ä¸¥æ ¼çš„è´¨é‡æ§åˆ¶æœºåˆ¶ï¼š

```python
class ShortcutQualityController:
    """æ€ç»´æ·å¾„è´¨é‡æ§åˆ¶å™¨"""
    
    def validate_shortcut(self, shortcut: MentalShortcut) -> bool:
        """éªŒè¯æ·å¾„è´¨é‡"""
        checks = []
        
        # 1. åŸºç¡€ä¿¡æ¯å®Œæ•´æ€§
        checks.append(bool(shortcut.app and shortcut.element))
        checks.append(bool(shortcut.typical_coords))
        
        # 2. ä½¿ç”¨ç»Ÿè®¡
        checks.append(shortcut.usage_count >= 3)
        success_rate = shortcut.success_count / shortcut.usage_count
        checks.append(success_rate >= 0.8)
        
        # 3. åæ ‡ç¨³å®šæ€§
        if shortcut.coord_variance:
            max_variance = max(shortcut.coord_variance)
            checks.append(max_variance < 100)  # åæ ‡å˜åŒ–ä¸èƒ½å¤ªå¤§
        
        # 4. ç½®ä¿¡åº¦
        checks.append(shortcut.confidence >= 0.7)
        
        # 5. æ—¶é—´æœ‰æ•ˆæ€§ï¼ˆå¯é€‰ï¼‰
        # å¦‚æœæ·å¾„å¤ªæ—§ï¼ˆå¦‚6ä¸ªæœˆï¼‰ï¼Œå¯èƒ½éœ€è¦é‡æ–°éªŒè¯
        
        return all(checks)
    
    def should_inject(self, shortcut: MentalShortcut, context: Dict) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥æ³¨å…¥"""
        # åŸºç¡€éªŒè¯
        if not self.validate_shortcut(shortcut):
            return False
        
        # ä¸Šä¸‹æ–‡åŒ¹é…
        if context.get('app') != shortcut.app:
            return False
        
        # åœºæ™¯åŒ¹é…ï¼ˆå¦‚æœæä¾›äº†åœºæ™¯ï¼‰
        if scene := context.get('scene'):
            if shortcut.scene != scene:
                return False
        
        # ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰
        min_confidence = context.get('min_confidence', 0.8)
        if shortcut.confidence < min_confidence:
            return False
        
        return True
```

### 6.5 æ€»ç»“ï¼šæˆ‘çš„æ ¸å¿ƒè§‚ç‚¹

åŸºäºå¯¹æ–‡æ¡£çš„æ·±å…¥åˆ†æï¼Œæˆ‘çš„æ ¸å¿ƒè§‚ç‚¹æ˜¯ï¼š

1. **æ€ç»´æ·å¾„ç³»ç»Ÿæ˜¯æ­£ç¡®æ–¹å‘**ï¼Œä½†éœ€è¦æ›´ä¸¥æ ¼çš„è´¨é‡æ§åˆ¶
2. **å¤šæºèåˆæ˜¯å¿…é¡»çš„**ï¼Œä¸èƒ½ä¾èµ–å•ä¸€æ•°æ®æº
3. **æ¸è¿›å¼å®æ–½æ˜¯æ˜æ™ºçš„**ï¼Œå…ˆä¿å®ˆåæ‰©å±•
4. **ä¸é»„é‡‘è·¯å¾„ååŒæ˜¯å…³é”®**ï¼Œä¸¤è€…äº’è¡¥è€Œéç«äº‰
5. **é€‚é…å°æ¨¡å‹æ˜¯æ ¸å¿ƒ**ï¼Œä¿¡æ¯é‡è¦æ§åˆ¶ï¼Œæç¤ºè¦ç®€æ´

**æœ€é‡è¦çš„æ”¹è¿›**ï¼š
- å¢åŠ æ›´ä¸¥æ ¼çš„æ•°æ®è´¨é‡éªŒè¯æœºåˆ¶
- å®ç°åˆ†æ­¥éª¤çš„åŠ¨æ€æç¤ºè¯è°ƒæ•´
- å»ºç«‹å¤šå±‚æ¬¡çš„å›é€€æœºåˆ¶ï¼ˆåæ ‡ â†’ ç›¸å¯¹ä½ç½® â†’ å…ƒç´ ç‰¹å¾ï¼‰
- ä¸ç°æœ‰ç³»ç»Ÿæ— ç¼æ•´åˆï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

---

## ä¸ƒã€å¯¹æ–‡æ¡£æ›´æ–°å†…å®¹çš„è¯„ä»·ï¼ˆ"åã€ChatGPT è¡¥å……è§‚ç‚¹æ•´åˆ"å’Œ"åä¸€ã€æœ€ç»ˆæ–¹æ¡ˆç¡®è®¤"ï¼‰

### 7.1 å…³äº"æ•°æ®æºå¯é æ€§åˆ†å±‚"çš„è¯„ä»·

æ–‡æ¡£ä¸­æå‡ºçš„æ•°æ®æºå¯é æ€§æ’åºéå¸¸åˆç†ï¼š

```python
1. action['element'] - 100%å‡†ç¡®
2. screenshot_analysis - 90%å‡†ç¡®
3. thinkingä¸­çš„åæ ‡ - 70%å‡†ç¡®
4. thinkingä¸­çš„ä½ç½®æè¿° - 50%å‡†ç¡®ï¼Œä½†æ›´ç¨³å®š
```

**æˆ‘çš„è¯„ä»·**ï¼š
âœ… **å®Œå…¨èµåŒ**è¿™ä¸ªä¼˜å…ˆçº§æ’åºã€‚è¿™ä¸ªåˆ†å±‚ç­–ç•¥éå¸¸å®ç”¨ï¼š
- ä¼˜å…ˆä½¿ç”¨æœ€å¯é çš„æ•°æ®æºï¼ˆactionåæ ‡ï¼‰
- é€æ­¥å›é€€åˆ°æ¬¡å¯é çš„æ•°æ®æº
- å³ä½¿æœ€ä¸å¯é çš„ä½ç½®æè¿°ä¹Ÿæœ‰ä»·å€¼ï¼ˆç¨³å®šæ€§é«˜ï¼‰

**è¡¥å……å»ºè®®**ï¼š
å¯ä»¥å¢åŠ ä¸€ä¸ª"ç½®ä¿¡åº¦è¡°å‡"æœºåˆ¶ï¼š
```python
def calculate_confidence(data_source: str, raw_confidence: float) -> float:
    """æ ¹æ®æ•°æ®æºç±»å‹è°ƒæ•´ç½®ä¿¡åº¦"""
    source_weights = {
        'action': 1.0,      # ä¸è¡°å‡
        'screenshot': 0.9,  # è½»å¾®è¡°å‡
        'thinking_coords': 0.7,  # æ˜æ˜¾è¡°å‡
        'thinking_location': 0.5  # å¤§å¹…è¡°å‡
    }
    return raw_confidence * source_weights.get(data_source, 0.5)
```

### 7.2 å…³äº"å…ƒç´ ç‰¹å¾åŒ¹é…"çš„è¯„ä»·

æ–‡æ¡£ä¸­æå‡ºçš„å…ƒç´ ç‰¹å¾åŒ¹é…å’Œå›é€€æœºåˆ¶å¾ˆæœ‰ä»·å€¼ï¼š

**æˆ‘çš„è¯„ä»·**ï¼š
âœ… **éå¸¸èµåŒ**è¿™ä¸ªè®¾è®¡ã€‚å¤šå±‚æ¬¡å›é€€æœºåˆ¶æ˜¯å¿…é¡»çš„ï¼š
```
åæ ‡åŒ¹é… â†’ ç›¸å¯¹ä½ç½®åŒ¹é… â†’ å…ƒç´ ç‰¹å¾åŒ¹é…ï¼ˆOCRæ–‡æœ¬/å›¾æ ‡ï¼‰
```

**è¡¥å……æ€è€ƒ**ï¼š
1. **å…ƒç´ ç‰¹å¾æå–çš„æ—¶æœº**ï¼š
   - ç¬¬ä¸€é˜¶æ®µï¼šæš‚ä¸å®ç°ï¼ˆéœ€è¦OCR/UIåˆ†æèƒ½åŠ›ï¼‰
   - ç¬¬äºŒé˜¶æ®µï¼šå¯ä»¥å¼€å§‹æ”¶é›†ï¼ˆå¦‚æœæœ‰screenshot_analysisï¼‰
   - ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå…¨è‡ªåŠ¨åŒ–

2. **ç‰¹å¾åŒ¹é…çš„ä¼˜å…ˆçº§**ï¼š
   ```python
   # ç‰¹å¾åŒ¹é…ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰
   1. OCRæ–‡æœ¬åŒ¹é… - "æœç´¢"ã€"å‘é€"ç­‰ï¼ˆæœ€å‡†ç¡®ï¼‰
   2. å›¾æ ‡ç±»å‹åŒ¹é… - "search"ã€"send"ç­‰ï¼ˆæ¬¡å‡†ç¡®ï¼‰
   3. ä½ç½®æ ‡ç­¾åŒ¹é… - "top_center"ã€"bottom_nav"ç­‰ï¼ˆè¡¥å……ï¼‰
   4. å¤§å°æ ‡ç­¾åŒ¹é… - "large"ã€"small"ç­‰ï¼ˆè¾…åŠ©ï¼‰
   ```

3. **ç‰¹å¾åŒ¹é…çš„å®¹é”™æ€§**ï¼š
   ```python
   def match_by_features(self, target_element: str, screenshot_features: Dict) -> Optional[Tuple[int, int]]:
       """é€šè¿‡ç‰¹å¾åŒ¹é…æ‰¾åˆ°å…ƒç´ """
       # 1. ç²¾ç¡®æ–‡æœ¬åŒ¹é…
       if match := self._exact_text_match(target_element, screenshot_features):
           return match, confidence=0.95
       
       # 2. æ¨¡ç³Šæ–‡æœ¬åŒ¹é…ï¼ˆå®¹é”™ï¼‰
       if match := self._fuzzy_text_match(target_element, screenshot_features):
           return match, confidence=0.85
       
       # 3. å›¾æ ‡ç±»å‹åŒ¹é…
       if match := self._icon_match(target_element, screenshot_features):
           return match, confidence=0.75
       
       return None
   ```

### 7.3 å…³äº"åˆ†æ­¥éª¤åŠ¨æ€æç¤ºè¯"çš„è¯„ä»·

æ–‡æ¡£ä¸­æå‡ºçš„åˆ†æ­¥éª¤åŠ¨æ€æç¤ºè¯æ˜¯**éå¸¸é‡è¦çš„æ”¹è¿›**ï¼š

**æˆ‘çš„è¯„ä»·**ï¼š
âœ… **å®Œå…¨èµåŒ**ï¼Œè¿™æ˜¯é€‚é…å°æ¨¡å‹çš„å…³é”®ç­–ç•¥ã€‚

**å…³é”®ä»·å€¼**ï¼š
1. **é¿å…ä¿¡æ¯è¿‡è½½**ï¼šå°æ¨¡å‹æ— æ³•å¤„ç†å¤ªå¤šä¿¡æ¯
2. **æŒ‰éœ€æä¾›**ï¼šä¸åŒæ­¥éª¤éœ€è¦ä¸åŒçš„æŒ‡å¯¼
3. **æé«˜æ•ˆç‡**ï¼šå‡å°‘ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡

**è¡¥å……å»ºè®®**ï¼š
å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–æ­¥éª¤åˆ’åˆ†ï¼š
```python
def build_enhanced_prompt(self, task, golden_path, shortcuts, step_num, current_app, current_scene):
    """æ›´ç»†åŒ–çš„åˆ†æ­¥éª¤æç¤ºè¯"""
    prompt_parts = [task]
    
    # ========== æ­¥éª¤1ï¼šä»»åŠ¡æ¦‚è§ˆ ==========
    if step_num == 1:
        if golden_path and golden_path.get('correct_path'):
            prompt_parts.append("\n\nğŸ“‹ ä»»åŠ¡å°†åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š")
            # æ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤ï¼Œä½†åªæ˜¾ç¤ºæ¦‚è¦
            for i, step in enumerate(golden_path['correct_path'], 1):
                prompt_parts.append(f"{i}. {step}")
        
        if golden_path and golden_path.get('forbidden'):
            prompt_parts.append("\n\nâŒ é‡è¦çº¦æŸï¼š")
            for f in golden_path['forbidden'][:2]:
                prompt_parts.append(f"- {f}")
    
    # ========== æ­¥éª¤2-3ï¼šå½“å‰æ­¥éª¤è¯¦ç»†æŒ‡å¯¼ ==========
    elif step_num in [2, 3]:
        if golden_path and golden_path.get('correct_path'):
            current_step = golden_path['correct_path'][step_num - 1]
            prompt_parts.append(f"\n\nğŸ“‹ å½“å‰æ­¥éª¤ï¼ˆæ­¥éª¤{step_num}ï¼‰ï¼š{current_step}")
            
            # æ˜¾ç¤ºä¸‹ä¸€æ­¥é¢„è§ˆï¼ˆå¦‚æœæœ‰ï¼‰
            if step_num < len(golden_path['correct_path']):
                next_step = golden_path['correct_path'][step_num]
                prompt_parts.append(f"ä¸‹ä¸€æ­¥ï¼š{next_step}")
    
    # ========== æ­¥éª¤4+ï¼šå…ƒç´ ä½ç½®æŒ‡å¯¼ ==========
    else:
        shortcuts = self.shortcut_repo.find_by_app_scene(current_app, current_scene)
        if shortcuts:
            prompt_parts.append(f"\n\nğŸ“ å½“å‰é¡µé¢å…ƒç´ ä½ç½®æç¤ºï¼š")
            # åªæ˜¾ç¤º3ä¸ªæœ€ç›¸å…³çš„
            for sc in shortcuts[:3]:
                coord_str = f"({sc.typical_coords[0]},{sc.typical_coords[1]})"
                prompt_parts.append(f"- {sc.element}: {sc.location_hint}ï¼Œå‚è€ƒ{coord_str}")
    
    return "\n".join(prompt_parts)
```

### 7.4 å…³äº"è´¨é‡æ§åˆ¶å™¨"çš„è¯„ä»·

æ–‡æ¡£ä¸­æå‡ºçš„è´¨é‡æ§åˆ¶å™¨è®¾è®¡å¾ˆå®Œå–„ï¼š

**æˆ‘çš„è¯„ä»·**ï¼š
âœ… **å®Œå…¨èµåŒ**ï¼Œè´¨é‡æ§åˆ¶æ˜¯ç³»ç»Ÿå¯é æ€§çš„åŸºç¡€ã€‚

**è¡¥å……å»ºè®®**ï¼š
å¯ä»¥å¢åŠ æ›´ç»†åŒ–çš„éªŒè¯è§„åˆ™ï¼š
```python
class EnhancedShortcutQualityController:
    """å¢å¼ºç‰ˆè´¨é‡æ§åˆ¶å™¨"""
    
    def validate_shortcut(self, shortcut: MentalShortcut) -> Tuple[bool, str]:
        """
        éªŒè¯æ·å¾„è´¨é‡ï¼Œè¿”å›(æ˜¯å¦é€šè¿‡, å¤±è´¥åŸå› )
        """
        # 1. åŸºç¡€ä¿¡æ¯å®Œæ•´æ€§
        if not shortcut.app or not shortcut.element:
            return False, "ç¼ºå°‘åº”ç”¨åæˆ–å…ƒç´ å"
        
        if not shortcut.typical_coords:
            return False, "ç¼ºå°‘åæ ‡ä¿¡æ¯"
        
        # 2. ä½¿ç”¨ç»Ÿè®¡ï¼ˆåˆ†é˜¶æ®µé˜ˆå€¼ï¼‰
        stage = self._get_current_stage()  # è·å–å½“å‰å®æ–½é˜¶æ®µ
        min_usage = 5 if stage == 1 else 3
        min_success_rate = 0.95 if stage == 1 else 0.8
        
        if shortcut.usage_count < min_usage:
            return False, f"ä½¿ç”¨æ¬¡æ•°ä¸è¶³ï¼ˆéœ€è¦â‰¥{min_usage}æ¬¡ï¼‰"
        
        success_rate = shortcut.success_count / shortcut.usage_count
        if success_rate < min_success_rate:
            return False, f"æˆåŠŸç‡ä¸è¶³ï¼ˆéœ€è¦â‰¥{min_success_rate:.0%}ï¼‰"
        
        # 3. åæ ‡ç¨³å®šæ€§
        if shortcut.coord_variance:
            max_variance = max(shortcut.coord_variance)
            max_allowed = 30 if stage == 1 else 50
            if max_variance > max_allowed:
                return False, f"åæ ‡å˜åŒ–å¤ªå¤§ï¼ˆæ–¹å·®>{max_allowed}ï¼‰"
        
        # 4. ç½®ä¿¡åº¦
        min_confidence = 0.9 if stage == 1 else 0.7
        if shortcut.confidence < min_confidence:
            return False, f"ç½®ä¿¡åº¦ä¸è¶³ï¼ˆéœ€è¦â‰¥{min_confidence:.0%}ï¼‰"
        
        # 5. æ—¶é—´æœ‰æ•ˆæ€§ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰
        if stage >= 3:
            if self._is_too_old(shortcut):
                return False, "æ·å¾„å¤ªæ—§ï¼Œéœ€è¦é‡æ–°éªŒè¯"
        
        return True, "éªŒè¯é€šè¿‡"
    
    def _get_current_stage(self) -> int:
        """è·å–å½“å‰å®æ–½é˜¶æ®µ"""
        # å¯ä»¥é€šè¿‡é…ç½®æˆ–ç¯å¢ƒå˜é‡æ§åˆ¶
        return 1  # é»˜è®¤ç¬¬ä¸€é˜¶æ®µ
```

### 7.5 å…³äº"æ¸è¿›å¼å­¦ä¹ é˜ˆå€¼"çš„è¯„ä»·

æ–‡æ¡£ä¸­æå‡ºçš„æ¸è¿›å¼å­¦ä¹ é˜ˆå€¼éå¸¸åˆç†ï¼š

| é˜¶æ®µ | ä½¿ç”¨æ¬¡æ•° | æˆåŠŸç‡ | åæ ‡æ–¹å·® |
|------|---------|--------|---------|
| ç¬¬ä¸€é˜¶æ®µï¼ˆä¿å®ˆï¼‰ | â‰¥5æ¬¡ | â‰¥95% | <30 |
| ç¬¬äºŒé˜¶æ®µï¼ˆæ‰©å±•ï¼‰ | â‰¥3æ¬¡ | â‰¥80% | <50 |
| ç¬¬ä¸‰é˜¶æ®µï¼ˆè‡ªé€‚åº”ï¼‰ | åŠ¨æ€ | åŠ¨æ€ | åŠ¨æ€ |

**æˆ‘çš„è¯„ä»·**ï¼š
âœ… **å®Œå…¨èµåŒ**ï¼Œè¿™ä¸ªé˜ˆå€¼è®¾è®¡å¾ˆç§‘å­¦ï¼š
- ç¬¬ä¸€é˜¶æ®µï¼šéå¸¸ä¿å®ˆï¼Œç¡®ä¿æ•°æ®è´¨é‡
- ç¬¬äºŒé˜¶æ®µï¼šé€‚åº¦æ”¾å®½ï¼Œå¢åŠ æ•°æ®é‡
- ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå…¨è‡ªé€‚åº”ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

**è¡¥å……å»ºè®®**ï¼š
å¯ä»¥å¢åŠ "åº”ç”¨ç±»å‹"çš„å·®å¼‚åŒ–é˜ˆå€¼ï¼š
```python
def get_thresholds_by_app_type(self, app: str) -> Dict:
    """æ ¹æ®åº”ç”¨ç±»å‹è¿”å›ä¸åŒçš„é˜ˆå€¼"""
    app_types = {
        'ç¤¾äº¤': {'min_usage': 3, 'min_success_rate': 0.85, 'max_variance': 40},
        'è´­ç‰©': {'min_usage': 4, 'min_success_rate': 0.90, 'max_variance': 35},
        'å·¥å…·': {'min_usage': 5, 'min_success_rate': 0.95, 'max_variance': 30},
        'é»˜è®¤': {'min_usage': 5, 'min_success_rate': 0.95, 'max_variance': 30}
    }
    
    app_type = self._classify_app(app)
    return app_types.get(app_type, app_types['é»˜è®¤'])
```

### 7.6 å…³äº"æœ€ç»ˆæ–¹æ¡ˆç¡®è®¤"çš„è¯„ä»·

æ–‡æ¡£ä¸­æ•´åˆçš„æœ€ç»ˆæ–¹æ¡ˆéå¸¸å®Œæ•´ï¼š

**æ ¸å¿ƒæ¶æ„**ï¼š
- âœ… ç»Ÿä¸€ç»éªŒç³»ç»Ÿï¼ˆé»„é‡‘è·¯å¾„ + æ€ç»´æ·å¾„ï¼‰
- âœ… è´¨é‡æ§åˆ¶å™¨
- âœ… åˆ†æ­¥éª¤æç¤ºè¯æ„å»ºå™¨

**æˆ‘çš„è¯„ä»·**ï¼š
âœ… **æ¶æ„è®¾è®¡åˆç†**ï¼Œæ•´åˆäº†æ‰€æœ‰è®¨è®ºçš„è¦ç‚¹ã€‚

**è¡¥å……æ€è€ƒ**ï¼š
1. **å®æ–½ä¼˜å…ˆçº§**ï¼š
   - ç¬¬ä¸€é˜¶æ®µï¼šå…ˆå®ç°åŸºç¡€æå–å’Œå­˜å‚¨ï¼ŒéªŒè¯å¯è¡Œæ€§
   - ç¬¬äºŒé˜¶æ®µï¼šå¢åŠ åœºæ™¯è¯†åˆ«å’Œç‰¹å¾åŒ¹é…
   - ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå…¨è‡ªåŠ¨åŒ–å’Œä¼˜åŒ–

2. **é£é™©æ§åˆ¶**ï¼š
   - æ¯ä¸ªé˜¶æ®µéƒ½è¦æœ‰å›é€€æœºåˆ¶
   - å¦‚æœæ·å¾„å¤±æ•ˆï¼Œæ¨¡å‹åº”è¯¥èƒ½è‡ªåŠ¨å›é€€åˆ°æ­£å¸¸åˆ†æ
   - å¢åŠ ç›‘æ§å’Œæ—¥å¿—ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸

3. **æ€§èƒ½è€ƒè™‘**ï¼š
   - æ•°æ®åº“æŸ¥è¯¢è¦ä¼˜åŒ–ï¼ˆç´¢å¼•ï¼‰
   - æ·å¾„åŒ¹é…è¦å¿«é€Ÿï¼ˆç¼“å­˜å¸¸ç”¨æ·å¾„ï¼‰
   - æç¤ºè¯æ„å»ºè¦é«˜æ•ˆï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰

### 7.7 å…³äº"å¾…ç¡®è®¤äº‹é¡¹"çš„æ€è€ƒ

æ–‡æ¡£ä¸­æå‡ºçš„å¾…ç¡®è®¤äº‹é¡¹éƒ½å¾ˆå…³é”®ï¼š

1. **ç¬¬ä¸€é˜¶æ®µçš„éªŒè¯é˜ˆå€¼**ï¼šä½¿ç”¨â‰¥5æ¬¡ï¼ŒæˆåŠŸç‡â‰¥95%
   - **æˆ‘çš„å»ºè®®**ï¼šè¿™ä¸ªé˜ˆå€¼æ˜¯åˆç†çš„ï¼Œä½†å¯ä»¥è®¾ç½®ä¸€ä¸ª"å­¦ä¹ æœŸ"ï¼š
     - å‰10æ¬¡æ‰§è¡Œï¼šåªè®°å½•ï¼Œä¸æ³¨å…¥
     - 10æ¬¡åï¼šå¼€å§‹éªŒè¯å’Œæ³¨å…¥
     - è¿™æ ·å¯ä»¥é¿å…æ—©æœŸæ•°æ®å™ªéŸ³

2. **åœºæ™¯è¯†åˆ«**ï¼šç¬¬ä¸€é˜¶æ®µæ˜¯å¦å®Œå…¨è·³è¿‡ï¼Ÿ
   - **æˆ‘çš„å»ºè®®**ï¼šç¬¬ä¸€é˜¶æ®µå¯ä»¥ç®€åŒ–åœºæ™¯è¯†åˆ«ï¼š
     - åªåŒºåˆ†"ä¸»é¡µ"å’Œ"éä¸»é¡µ"ï¼ˆé€šè¿‡åº•éƒ¨å¯¼èˆªæ æ£€æµ‹ï¼‰
     - ä¸è¿›è¡Œå¤æ‚çš„åœºæ™¯åˆ†ç±»
     - ç¬¬äºŒé˜¶æ®µå†å®ç°å®Œæ•´çš„åœºæ™¯è¯†åˆ«

3. **æ•°æ®åº“ç»“æ„**ï¼šæ–°å»ºè¡¨è¿˜æ˜¯æ‰©å±•ç°æœ‰è¡¨ï¼Ÿ
   - **æˆ‘çš„å»ºè®®**ï¼š**æ–°å»ºè¡¨**ï¼ŒåŸå› ï¼š
     - æ€ç»´æ·å¾„å’Œé»„é‡‘è·¯å¾„çš„æ•°æ®ç»“æ„ä¸åŒ
     - æŸ¥è¯¢æ¨¡å¼ä¸åŒï¼ˆæŒ‰åº”ç”¨+åœºæ™¯ vs æŒ‰ä»»åŠ¡æ¨¡å¼ï¼‰
     - ä¾¿äºç‹¬ç«‹ä¼˜åŒ–å’Œç»´æŠ¤
     - ä½†å¯ä»¥åœ¨åº”ç”¨å±‚é¢æ•´åˆæŸ¥è¯¢

4. **ä¸ç°æœ‰ç³»ç»Ÿçš„æ•´åˆç‚¹**ï¼šä¼˜å…ˆä¿®æ”¹å“ªä¸ªæ–‡ä»¶ï¼Ÿ
   - **æˆ‘çš„å»ºè®®**ï¼šä¼˜å…ˆçº§é¡ºåºï¼š
     1. `AgentRunner.run_task()` - ä»»åŠ¡å¼€å§‹æ—¶æ³¨å…¥
     2. `AgentRunner._build_enhanced_prompt()` - å¢å¼ºæç¤ºè¯
     3. `PhoneAgent._execute_step()` - æ¯æ­¥æ‰§è¡Œæ—¶åŠ¨æ€è°ƒæ•´
     4. `GoldenPathExtractor` - æå–æ—¶åŒæ—¶æå–æ·å¾„

### 7.8 æ€»ç»“ï¼šå¯¹æ–‡æ¡£æ›´æ–°çš„æ•´ä½“è¯„ä»·

**ä¼˜ç‚¹**ï¼š
1. âœ… æ•´åˆäº†å¤šè½®è®¨è®ºçš„ç²¾å
2. âœ… æ–¹æ¡ˆè®¾è®¡å®Œæ•´ä¸”å¯å®æ–½
3. âœ… è€ƒè™‘äº†å°æ¨¡å‹çš„é™åˆ¶
4. âœ… æœ‰æ˜ç¡®çš„åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

**å»ºè®®**ï¼š
1. âš ï¸ ç¬¬ä¸€é˜¶æ®µè¦æ›´ä¿å®ˆï¼Œç¡®ä¿æ•°æ®è´¨é‡
2. âš ï¸ æ¯ä¸ªé˜¶æ®µéƒ½è¦æœ‰æ˜ç¡®çš„éªŒè¯æŒ‡æ ‡
3. âš ï¸ å¢åŠ ç›‘æ§å’Œæ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. âš ï¸ é¢„ç•™å›é€€æœºåˆ¶ï¼Œé¿å…ç³»ç»Ÿå¤±æ•ˆ

**æ ¸å¿ƒä»·å€¼**ï¼š
é€šè¿‡æ€ç»´æ·å¾„ç³»ç»Ÿï¼Œè®©æ¨¡å‹å½¢æˆ"ä½ç½®è®°å¿†"ï¼Œè¿™æ˜¯æé«˜æ‰§è¡ŒæˆåŠŸç‡çš„å…³é”®ã€‚é…åˆé»„é‡‘è·¯å¾„çš„ä»»åŠ¡çº§æŒ‡å¯¼ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒã€‚

---

## å…«ã€å¯¹æ–‡æ¡£æœ€ç»ˆæ›´æ–°ï¼ˆ"åä¸‰ã€åå››ã€åäº”ç« "ï¼‰çš„è¯„ä»·

### 8.1 æ•´ä½“è¯„ä»·ï¼šâœ… å®Œå…¨è®¤åŒ

æ–‡æ¡£æ•´åˆäº†ä¸‰è½®è®¨è®ºçš„ç²¾åï¼Œå½¢æˆäº†å®Œæ•´ã€å¯å®æ–½çš„æœ€ç»ˆæ–¹æ¡ˆã€‚æˆ‘å¯¹è¿™ä¸ªæ›´æ–°**å®Œå…¨è®¤åŒ**ã€‚

### 8.2 å¯¹"ç¬¬åä¸‰ç« ï¼šChatGPT ç¬¬ä¸‰è½®è¯„ä»·ä¸è¡¥å……"çš„è¯„ä»·

#### 8.2.1 ChatGPTçš„æ•´ä½“è¯„ä»·

æ–‡æ¡£ä¸­è®°å½•ChatGPTå¯¹æ–¹æ¡ˆç»™å‡ºäº†"å®Œå…¨èµåŒ"çš„è¯„ä»·ï¼Œè¿™ä¸ªè¯„ä»·æ˜¯åˆç†çš„ã€‚æ‰€æœ‰å…³é”®ç‚¹éƒ½å¾—åˆ°äº†è®¤å¯ï¼š
- âœ… æ•°æ®æºå¯é æ€§åˆ†å±‚
- âœ… å…ƒç´ ç‰¹å¾åŒ¹é…
- âœ… åˆ†æ­¥éª¤åŠ¨æ€æç¤ºè¯
- âœ… è´¨é‡æ§åˆ¶å™¨
- âœ… æ¸è¿›å¼å­¦ä¹ é˜ˆå€¼
- âœ… æœ€ç»ˆæ–¹æ¡ˆæ¶æ„

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™äº›è¯„ä»·å‡†ç¡®åæ˜ äº†æ–¹æ¡ˆçš„æ ¸å¿ƒä»·å€¼ã€‚

#### 8.2.2 æ–°å¢è¡¥å……å»ºè®®çš„è¯„ä»·

**è¡¥å……1ï¼šç½®ä¿¡åº¦è¡°å‡æœºåˆ¶**
- âœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™ä¸ªæœºåˆ¶å¾ˆå®ç”¨ï¼Œèƒ½æ ¹æ®æ•°æ®æºå¯é æ€§è‡ªåŠ¨è°ƒæ•´ç½®ä¿¡åº¦ã€‚
- å»ºè®®ï¼šå¯ä»¥åœ¨æ•°æ®åº“è¡¨ä¸­å¢åŠ  `data_source` å­—æ®µï¼Œè®°å½•æ•°æ®æ¥æºç±»å‹ã€‚

**è¡¥å……2ï¼šç‰¹å¾åŒ¹é…ä¼˜å…ˆçº§**
- âœ… **å®Œå…¨è®¤åŒ**ã€‚ä¼˜å…ˆçº§æ’åºåˆç†ï¼ˆOCRæ–‡æœ¬ > å›¾æ ‡ç±»å‹ > ä½ç½®æ ‡ç­¾ > å¤§å°æ ‡ç­¾ï¼‰ã€‚
- å»ºè®®ï¼šç¬¬äºŒé˜¶æ®µå®ç°æ—¶ï¼Œå¯ä»¥å…ˆå®ç°OCRæ–‡æœ¬åŒ¹é…ï¼Œå…¶ä»–ä½œä¸ºè¡¥å……ã€‚

**è¡¥å……3ï¼šæ›´ç»†åŒ–çš„æ­¥éª¤åˆ’åˆ†**
- âœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™ä¸ªåˆ’åˆ†éå¸¸ç»†è‡´ï¼Œèƒ½æ›´å¥½åœ°é€‚é…å°æ¨¡å‹ï¼š
  - æ­¥éª¤1ï¼šä»»åŠ¡æ¦‚è§ˆï¼ˆç»™æ¨¡å‹æ•´ä½“è®¤çŸ¥ï¼‰
  - æ­¥éª¤2-3ï¼šå½“å‰æ­¥éª¤è¯¦ç»†æŒ‡å¯¼ï¼ˆèšç„¦å½“å‰ä»»åŠ¡ï¼‰
  - æ­¥éª¤4+ï¼šå…ƒç´ ä½ç½®æŒ‡å¯¼ï¼ˆæä¾›ä½ç½®ä¿¡æ¯ï¼‰
- å»ºè®®ï¼šè¿™ä¸ªåˆ’åˆ†å¯ä»¥ç›´æ¥ç”¨äºå®ç°ã€‚

**è¡¥å……4ï¼šå­¦ä¹ æœŸæœºåˆ¶**
- âœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™æ˜¯é¿å…æ—©æœŸæ•°æ®å™ªéŸ³çš„å…³é”®æœºåˆ¶ã€‚
- å»ºè®®ï¼šå­¦ä¹ æœŸå¯ä»¥è®¾ç½®ä¸ºå¯é…ç½®å‚æ•°ï¼Œä¸åŒåº”ç”¨å¯ä»¥è®¾ç½®ä¸åŒçš„å­¦ä¹ æœŸã€‚

**è¡¥å……5ï¼šåº”ç”¨ç±»å‹å·®å¼‚åŒ–é˜ˆå€¼**
- âœ… **éƒ¨åˆ†è®¤åŒ**ã€‚è¿™ä¸ªæƒ³æ³•å¾ˆå¥½ï¼Œä½†ç¡®å®åº”è¯¥æ”¾åœ¨ç¬¬ä¸‰é˜¶æ®µã€‚
- å»ºè®®ï¼šç¬¬ä¸€é˜¶æ®µå…ˆç»Ÿä¸€é˜ˆå€¼ï¼Œç§¯ç´¯æ•°æ®åå†è€ƒè™‘å·®å¼‚åŒ–ã€‚

### 8.3 å¯¹"ç¬¬åå››ç« ï¼šæœ€ç»ˆç¡®è®¤æ–¹æ¡ˆ"çš„è¯„ä»·

#### 8.3.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™

æ–‡æ¡£æå‡ºçš„4ä¸ªæ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š
1. **æ•°æ®è´¨é‡ä¼˜å…ˆ**ï¼šå®å¯å°‘æå–ï¼Œä¹Ÿä¸è¦æå–é”™è¯¯ä¿¡æ¯
2. **æ¸è¿›å¼å®æ–½**ï¼šå…ˆä¿å®ˆåæ‰©å±•ï¼Œæ¯é˜¶æ®µéªŒè¯æ•ˆæœ
3. **é€‚é…å°æ¨¡å‹**ï¼šä¿¡æ¯é‡æ§åˆ¶ï¼Œæç¤ºè¯ç®€æ´
4. **å¤šå±‚æ¬¡å›é€€**ï¼šåæ ‡ â†’ ç›¸å¯¹ä½ç½® â†’ å…ƒç´ ç‰¹å¾ â†’ æ¨¡å‹è‡ªå·±åˆ†æ

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™4ä¸ªåŸåˆ™æ˜¯æ–¹æ¡ˆæˆåŠŸçš„å…³é”®ã€‚

#### 8.3.2 ç¬¬ä¸€é˜¶æ®µå®æ–½ç»†èŠ‚

**éªŒè¯æ¡ä»¶**ï¼š
- å­¦ä¹ æœŸï¼šå‰10æ¬¡åªè®°å½•ï¼Œä¸æ³¨å…¥ âœ…
- å­¦ä¹ æœŸåï¼šä½¿ç”¨â‰¥5æ¬¡ï¼ŒæˆåŠŸç‡â‰¥95%ï¼Œåæ ‡æ–¹å·®<30 âœ…

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™ä¸ªéªŒè¯æ¡ä»¶å¾ˆä¸¥æ ¼ï¼Œä½†èƒ½ç¡®ä¿æ•°æ®è´¨é‡ã€‚

**åœºæ™¯è¯†åˆ«**ï¼š
- ç®€åŒ–ä¸ºåªåŒºåˆ†"ä¸»é¡µ"å’Œ"éä¸»é¡µ" âœ…
- é€šè¿‡æ£€æµ‹åº•éƒ¨å¯¼èˆªæ å®ç° âœ…

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚ç¬¬ä¸€é˜¶æ®µç®€åŒ–åœºæ™¯è¯†åˆ«æ˜¯æ˜æ™ºçš„ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–ã€‚

**æ•´åˆé¡ºåº**ï¼š
1. `AgentRunner.run_task()` âœ…
2. `AgentRunner._build_enhanced_prompt()` âœ…
3. åç»­å†æ‰©å±•åˆ°å…¶ä»–ç»„ä»¶ âœ…

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™ä¸ªé¡ºåºåˆç†ï¼Œå…ˆæ ¸å¿ƒåæ‰©å±•ã€‚

#### 8.3.3 æ•°æ®åº“è¡¨ç»“æ„

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚è¡¨ç»“æ„è®¾è®¡åˆç†ï¼š
- å­—æ®µå®Œæ•´ï¼ˆåŸºç¡€ä¿¡æ¯ã€ä½ç½®ä¿¡æ¯ã€åŠ¨ä½œä¿¡æ¯ã€ç»Ÿè®¡ä¿¡æ¯ï¼‰
- ç´¢å¼•åˆç†ï¼ˆappã€app+sceneã€confidenceï¼‰
- æ•°æ®ç±»å‹åˆé€‚ï¼ˆJSONå­˜å‚¨å¤æ‚æ•°æ®ï¼‰

**è¡¥å……å»ºè®®**ï¼š
å¯ä»¥å¢åŠ ä¸€ä¸ª `last_used_at` å­—æ®µï¼Œç”¨äºè®°å½•æœ€åä½¿ç”¨æ—¶é—´ï¼Œä¾¿äºåç»­çš„"æ—¶é—´æœ‰æ•ˆæ€§"éªŒè¯ã€‚

#### 8.3.4 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ç¬¬ä¸€é˜¶æ®µå |
|------|------|-----------|
| æ‰§è¡ŒæˆåŠŸç‡ | ~60% | ~70% |
| å¹³å‡æ‰§è¡Œæ—¶é—´ | åŸºå‡† | -10% |
| ç”¨æˆ·è¾“å…¥å¤æ‚åº¦ | é«˜ | ä¸­ |
| æ•°æ®è´¨é‡ | - | é«˜ |

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **åˆç†é¢„æœŸ**ã€‚è¿™äº›é¢„æœŸæ˜¯ä¿å®ˆä¸”å¯å®ç°çš„ã€‚

### 8.4 å¯¹"ç¬¬åäº”ç« ï¼šå¼€å§‹å®ç°"çš„è¯„ä»·

**å®ç°é¡ºåº**ï¼š
1. åˆ›å»ºæ•°æ®åº“è¡¨ âœ…
2. å®ç° ThinkingExtractor âœ…
3. å®ç° MentalShortcutRepository âœ…
4. å®ç° ShortcutQualityControllerï¼ˆå«å­¦ä¹ æœŸï¼‰âœ…
5. å®ç° ShortcutInjector âœ…
6. ä¿®æ”¹ AgentRunner é›†æˆç³»ç»Ÿ âœ…
7. æµ‹è¯•å’ŒéªŒè¯ âœ…

**æˆ‘çš„è¯„ä»·**ï¼šâœ… **å®Œå…¨è®¤åŒ**ã€‚è¿™ä¸ªé¡ºåºåˆç†ï¼Œä»åº•å±‚åˆ°ä¸Šå±‚ï¼Œé€æ­¥æ„å»ºã€‚

### 8.5 æˆ‘çš„æœ€ç»ˆè¯„ä»·æ€»ç»“

#### âœ… å®Œå…¨è®¤åŒçš„éƒ¨åˆ†

1. **æ•´ä½“æ–¹æ¡ˆæ¶æ„**ï¼šç»Ÿä¸€ç»éªŒç³»ç»Ÿï¼ˆé»„é‡‘è·¯å¾„ + æ€ç»´æ·å¾„ï¼‰è®¾è®¡åˆç†
2. **æ•°æ®è´¨é‡ä¼˜å…ˆ**ï¼šä¸¥æ ¼éªŒè¯ + å­¦ä¹ æœŸæœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å¯é æ€§
3. **æ¸è¿›å¼å®æ–½**ï¼šåˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œå…ˆä¿å®ˆåæ‰©å±•ï¼Œé£é™©å¯æ§
4. **é€‚é…å°æ¨¡å‹**ï¼šåˆ†æ­¥éª¤åŠ¨æ€æç¤ºè¯ï¼Œä¿¡æ¯é‡æ§åˆ¶ï¼Œæç¤ºè¯ç®€æ´
5. **å¤šå±‚æ¬¡å›é€€**ï¼šåæ ‡ â†’ ç›¸å¯¹ä½ç½® â†’ å…ƒç´ ç‰¹å¾ â†’ æ¨¡å‹è‡ªå·±åˆ†æ
6. **å®æ–½ç»†èŠ‚**ï¼šéªŒè¯æ¡ä»¶ã€åœºæ™¯è¯†åˆ«ã€æ•´åˆé¡ºåºéƒ½å¾ˆåˆç†
7. **æ•°æ®åº“è®¾è®¡**ï¼šè¡¨ç»“æ„å®Œæ•´ï¼Œç´¢å¼•åˆç†

#### ğŸ’¡ è¡¥å……å»ºè®®

1. **ç›‘æ§å’Œæ—¥å¿—**ï¼š
   - è®°å½•æ·å¾„çš„ä½¿ç”¨æƒ…å†µï¼ˆå‘½ä¸­ç‡ã€æˆåŠŸç‡ï¼‰
   - è®°å½•æ·å¾„çš„å¤±æ•ˆæƒ…å†µï¼ˆä½•æ—¶å¤±æ•ˆã€å¤±æ•ˆåŸå› ï¼‰
   - å®šæœŸç”Ÿæˆè´¨é‡æŠ¥å‘Š

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ç¼“å­˜å¸¸ç”¨æ·å¾„ï¼ˆé¿å…é‡å¤æŸ¥è¯¢ï¼‰
   - æ‰¹é‡æŸ¥è¯¢ï¼ˆä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªæ·å¾„ï¼‰
   - å¼‚æ­¥æå–ï¼ˆä¸é˜»å¡ä»»åŠ¡æ‰§è¡Œï¼‰

3. **é”™è¯¯å¤„ç†**ï¼š
   - å¦‚æœæ·å¾„å¤±æ•ˆï¼Œè‡ªåŠ¨é™çº§åˆ°æ¨¡å‹è‡ªå·±åˆ†æ
   - å¦‚æœæå–å¤±è´¥ï¼Œä¸å½±å“ä»»åŠ¡æ‰§è¡Œ
   - å¦‚æœæ³¨å…¥å¤±è´¥ï¼Œå›é€€åˆ°åŸå§‹æç¤ºè¯

4. **æµ‹è¯•ç­–ç•¥**ï¼š
   - å•å…ƒæµ‹è¯•ï¼šæ¯ä¸ªç»„ä»¶ç‹¬ç«‹æµ‹è¯•
   - é›†æˆæµ‹è¯•ï¼šæµ‹è¯•ç»„ä»¶ä¹‹é—´çš„åä½œ
   - ç«¯åˆ°ç«¯æµ‹è¯•ï¼šæµ‹è¯•å®Œæ•´æµç¨‹

### 8.6 æœ€ç»ˆç»“è®º

**æˆ‘å¯¹æ–‡æ¡£çš„æœ€ç»ˆæ›´æ–°å®Œå…¨è®¤åŒ** âœ…

æ–‡æ¡£æ•´åˆäº†å¤šè½®è®¨è®ºçš„ç²¾åï¼Œå½¢æˆäº†ï¼š
- âœ… **å®Œæ•´**ï¼šè¦†ç›–äº†æ‰€æœ‰å…³é”®ç‚¹
- âœ… **å¯å®æ–½**ï¼šæœ‰æ˜ç¡®çš„å®æ–½æ­¥éª¤å’Œç»†èŠ‚
- âœ… **é£é™©å¯æ§**ï¼šæœ‰ä¸¥æ ¼çš„è´¨é‡æ§åˆ¶å’Œå›é€€æœºåˆ¶
- âœ… **é€‚é…å°æ¨¡å‹**ï¼šè€ƒè™‘äº†9Bæ¨¡å‹çš„é™åˆ¶

**å¯ä»¥å¼€å§‹å®æ–½äº†ï¼** ğŸš€

å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå®æ–½è¿‡ç¨‹ä¸­è¦æŒç»­ç›‘æ§å’Œè°ƒæ•´ï¼Œæ ¹æ®å®é™…æ•ˆæœä¼˜åŒ–ç­–ç•¥ã€‚

