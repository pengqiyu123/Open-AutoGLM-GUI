# Open-AutoGLM GUI 应用

基于 PyQt5 的可视化界面应用，提供友好的图形界面来使用 Open-AutoGLM 手机自动化功能。

## 功能特性

- **环境测试**：一键检查 ADB 安装、设备连接、ADB Keyboard 和模型 API 连接状态
- **ADB 设备管理**：自动检测和显示已连接的设备，支持远程设备连接
- **模型配置**：支持预设配置（ModelScope、智谱 BigModel）和自定义配置
- **任务执行**：输入自然语言任务，实时查看执行过程和思考过程
- **日志显示**：彩色日志输出，支持搜索和过滤，自动滚动

## 安装依赖

首先确保已安装项目的基础依赖：

```bash
pip install -r requirements.txt
pip install -e .
```

GUI 应用需要 PyQt5，已在 `requirements.txt` 中包含。如果未安装，可以单独安装：

```bash
pip install PyQt5>=5.15.0
```

## 运行应用

启动 GUI 应用：

```bash
python gui_app.py
```

或者：

```bash
python -m gui.main_window
```

## 使用指南

### 1. 配置模型服务

在左侧"模型配置"面板中：

- **预设配置**：选择预设（ModelScope 或智谱 BigModel）会自动填充对应的 Base URL 和 Model 名称
- **Base URL**：模型服务的 API 地址
  - ModelScope: `https://api-inference.modelscope.cn/v1`
  - 智谱 BigModel: `https://open.bigmodel.cn/api/paas/v4`
- **Model 名称**：模型标识符
  - ModelScope: `ZhipuAI/AutoGLM-Phone-9B`
  - 智谱 BigModel: `autoglm-phone`
- **API Key**：在对应平台申请的 API Key

配置会自动保存，下次启动时会自动加载。

### 2. 设备管理

#### 自动检测设备

设备列表每 3 秒自动刷新，显示所有已连接的设备。设备信息包括：
- 设备 ID
- 连接类型（USB/WiFi/Remote）
- 设备型号（如果可用）

点击设备列表中的设备即可选择。

#### 远程连接设备

1. 在设备上启用 TCP/IP 调试：
   ```bash
   adb tcpip 5555
   ```
2. 在 GUI 的"远程连接"输入框中输入设备 IP 和端口（如 `192.168.1.100:5555`）
3. 点击"连接"按钮
4. 连接成功后，设备会出现在设备列表中

### 3. 环境检查

点击"运行环境检查"按钮，系统会自动检查：

1. **ADB 安装**：检查 ADB 是否已安装并在 PATH 中
2. **设备连接**：检查是否有设备已连接
3. **ADB Keyboard**：检查设备上是否已安装并启用 ADB Keyboard
4. **模型 API**：检查模型服务是否可访问

检查结果会显示在状态标签和日志区域中。如果存在问题，会显示详细的错误信息和解决方案。

### 4. 执行任务

1. 在中间面板的"任务输入"文本框中输入任务描述（自然语言）
   - 例如：`打开微信，对文件传输助手发送消息：部署成功`
2. 点击"开始执行"按钮
3. 在右侧日志区域实时查看：
   - **思考过程**（蓝色）：AI 的推理过程
   - **执行动作**（橙色）：具体的操作指令
   - **成功消息**（绿色）：任务完成信息
   - **错误信息**（红色）：执行过程中的错误
4. 任务完成后，状态会更新为"已完成"

### 5. 日志查看

日志查看器提供以下功能：

- **彩色显示**：不同级别的日志使用不同颜色
- **自动滚动**：新日志自动滚动到底部（可关闭）
- **搜索功能**：在搜索框中输入关键词，匹配的内容会高亮显示
- **清空日志**：点击"清空日志"按钮清除所有日志

## 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│                    Open-AutoGLM GUI                          │
├──────────────┬──────────────┬──────────────────────────────┤
│  左侧配置    │  中间任务    │      右侧日志                 │
│              │              │                               │
│ 模型配置     │ 任务输入     │  日志输出（彩色）             │
│ - 预设选择   │ - 文本输入框 │  - 思考过程                   │
│ - Base URL   │              │  - 执行动作                   │
│ - Model      │ 控制按钮     │  - 系统消息                   │
│ - API Key    │ - 开始执行   │                               │
│              │ - 停止执行   │  搜索和过滤                   │
│ 设备配置     │              │                               │
│ - 设备列表   │ 任务状态     │                               │
│ - 刷新按钮   │ - 状态显示   │                               │
│ - 远程连接   │ - 进度信息   │                               │
│              │              │                               │
│ 环境检查     │              │                               │
│ - 检查按钮   │              │                               │
│ - 状态显示   │              │                               │
└──────────────┴──────────────┴──────────────────────────────┘
```

## 快捷键

- `Ctrl+Enter`：开始执行任务（待实现）
- `Ctrl+C`：停止当前任务（待实现）

## 配置持久化

应用使用 QSettings 保存用户配置，包括：
- Base URL
- Model 名称
- API Key（注意：API Key 以明文保存，请妥善保管）

配置文件位置：
- Windows: `HKEY_CURRENT_USER\Software\Open-AutoGLM\GUI`
- macOS: `~/Library/Preferences/com.Open-AutoGLM.GUI.plist`
- Linux: `~/.config/Open-AutoGLM/GUI.conf`

## 故障排除

### 问题：无法启动应用

**解决方案**：
1. 确保已安装 PyQt5: `pip install PyQt5>=5.15.0`
2. 检查 Python 版本（建议 3.8+）
3. 查看错误日志，根据错误信息处理

### 问题：设备列表为空

**解决方案**：
1. 检查 USB 调试是否已启用
2. 确认设备已通过 USB 连接或已建立远程连接
3. 尝试点击"刷新设备列表"按钮
4. 在命令行运行 `adb devices` 检查设备是否被识别

### 问题：环境检查失败

**解决方案**：
- **ADB 未安装**：按照错误提示安装 Android SDK Platform Tools
- **设备未连接**：连接设备并授权 USB 调试
- **ADB Keyboard 未安装**：下载并安装 ADB Keyboard APK，在系统设置中启用
- **模型 API 连接失败**：检查 Base URL 和 API Key 是否正确，确认网络连接正常

### 问题：任务执行失败

**解决方案**：
1. 检查模型配置是否正确
2. 确认设备已连接且被选中
3. 查看日志区域中的错误信息
4. 运行环境检查，确保所有检查项都通过

## 技术架构

### 主要组件

1. **MainWindow** (`gui/main_window.py`)
   - 主窗口类，管理所有 UI 组件和用户交互
   - 处理配置管理、设备管理、任务执行

2. **LogViewer** (`gui/widgets/log_viewer.py`)
   - 自定义日志显示组件
   - 支持彩色显示、搜索、自动滚动

3. **AgentRunner** (`gui/utils/agent_runner.py`)
   - 在后台线程运行 PhoneAgent
   - 通过 Qt 信号机制与 UI 通信

4. **SystemChecker** (`gui/utils/system_checker.py`)
   - 封装环境检查逻辑
   - 返回结构化的检查结果

### 线程模型

- **主线程**：UI 线程，处理所有界面更新
- **Agent 线程**：运行 PhoneAgent，执行任务
- **检查线程**：执行环境检查，避免阻塞 UI

所有线程间通信通过 Qt 信号槽机制实现，确保线程安全。

## 开发说明

### 添加新功能

1. **添加新的检查项**：
   - 在 `gui/utils/system_checker.py` 中添加新的检查函数
   - 在 `run_all_checks()` 中调用新函数

2. **自定义日志类型**：
   - 在 `gui/widgets/log_viewer.py` 的 `COLORS` 字典中添加新颜色
   - 添加对应的日志方法

3. **扩展设备管理**：
   - 在 `gui/main_window.py` 的 `_create_left_panel()` 中添加新控件
   - 实现对应的处理函数

## 许可证

与主项目相同，使用 Apache-2.0 许可证。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进 GUI 应用！

